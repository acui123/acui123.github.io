{"remainingRequest":"C:\\Users\\Administrator\\Desktop\\qd\\blog\\vuepress-blog-demo\\xcui-blog\\node_modules\\babel-loader\\lib\\index.js??ref--3-1!C:\\Users\\Administrator\\Desktop\\qd\\blog\\vuepress-blog-demo\\xcui-blog\\node_modules\\@vue\\composition-api\\dist\\vue-composition-api.esm.js","dependencies":[{"path":"C:\\Users\\Administrator\\Desktop\\qd\\blog\\vuepress-blog-demo\\xcui-blog\\node_modules\\@vue\\composition-api\\dist\\vue-composition-api.esm.js","mtime":1613623285000},{"path":"C:\\Users\\Administrator\\Desktop\\qd\\blog\\vuepress-blog-demo\\xcui-blog\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Administrator\\Desktop\\qd\\blog\\vuepress-blog-demo\\xcui-blog\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiQzovVXNlcnMvQWRtaW5pc3RyYXRvci9EZXNrdG9wL3FkL2Jsb2cvdnVlcHJlc3MtYmxvZy1kZW1vL3hjdWktYmxvZy9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vdHlwZW9mIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5kYXRlLnRvLXN0cmluZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN5bWJvbC5kZXNjcmlwdGlvbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZmxlY3Qub3duLWtleXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZGVmaW5lLXByb3BlcnR5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaXMtYXJyYXkuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5wYXJzZS1mbG9hdC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmZ1bmN0aW9uLm5hbWUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy53ZWFrLW1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5iaW5kLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZm9yLWVhY2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5jb25jYXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3Quc2VhbC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5rZXlzLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmdldC1vd24tcHJvcGVydHktZGVzY3JpcHRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5pcy1leHRlbnNpYmxlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5tYXAuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZnJlZXplLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5mb3ItZWFjaC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNvbWUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wudG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm1hdGgudG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmpzb24udG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCBWdWUgZnJvbSAndnVlJzsKCnZhciB0b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nKHgpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHgpOwp9OwoKZnVuY3Rpb24gaXNOYXRpdmUoQ3RvcikgewogIHJldHVybiB0eXBlb2YgQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAvbmF0aXZlIGNvZGUvLnRlc3QoQ3Rvci50b1N0cmluZygpKTsKfQoKdmFyIGhhc1N5bWJvbCA9IHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFN5bWJvbCkgJiYgdHlwZW9mIFJlZmxlY3QgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFJlZmxlY3Qub3duS2V5cyk7Cgp2YXIgbm9vcEZuID0gZnVuY3Rpb24gbm9vcEZuKF8pIHsKICByZXR1cm4gXzsKfTsKCnZhciBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24gPSB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUsCiAgZ2V0OiBub29wRm4sCiAgc2V0OiBub29wRm4KfTsKCmZ1bmN0aW9uIHByb3h5KHRhcmdldCwga2V5LCBfYSkgewogIHZhciBnZXQgPSBfYS5nZXQsCiAgICAgIHNldCA9IF9hLnNldDsKICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gZ2V0IHx8IG5vb3BGbjsKICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gc2V0IHx8IG5vb3BGbjsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIGRlZihvYmosIGtleSwgdmFsLCBlbnVtZXJhYmxlKSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICB2YWx1ZTogdmFsLAogICAgZW51bWVyYWJsZTogISFlbnVtZXJhYmxlLAogICAgd3JpdGFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKfQoKZnVuY3Rpb24gaGFzT3duKG9iaiwga2V5KSB7CiAgcmV0dXJuIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKfQoKZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbXNnKSB7CiAgaWYgKCFjb25kaXRpb24pIHsKICAgIHRocm93IG5ldyBFcnJvcigiW3Z1ZS1jb21wb3NpdGlvbi1hcGldICIgKyBtc2cpOwogIH0KfQoKZnVuY3Rpb24gaXNQcmltaXRpdmUodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8IC8vICRmbG93LWRpc2FibGUtbGluZQogIF90eXBlb2YodmFsdWUpID09PSAnc3ltYm9sJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKfQoKZnVuY3Rpb24gaXNBcnJheSh4KSB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoeCk7Cn0KCmZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4KHZhbCkgewogIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgcmV0dXJuIG4gPj0gMCAmJiBNYXRoLmZsb29yKG4pID09PSBuICYmIGlzRmluaXRlKHZhbCk7Cn0KCmZ1bmN0aW9uIGlzT2JqZWN0KHZhbCkgewogIHJldHVybiB2YWwgIT09IG51bGwgJiYgX3R5cGVvZih2YWwpID09PSAnb2JqZWN0JzsKfQoKZnVuY3Rpb24gaXNQbGFpbk9iamVjdCh4KSB7CiAgcmV0dXJuIHRvU3RyaW5nKHgpID09PSAnW29iamVjdCBPYmplY3RdJzsKfQoKZnVuY3Rpb24gaXNGdW5jdGlvbih4KSB7CiAgcmV0dXJuIHR5cGVvZiB4ID09PSAnZnVuY3Rpb24nOwp9CgpmdW5jdGlvbiBpc1VuZGVmKHYpIHsKICByZXR1cm4gdiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGw7Cn0KCmZ1bmN0aW9uIHdhcm4obXNnLCB2bSkgewogIFZ1ZS51dGlsLndhcm4obXNnLCB2bSk7Cn0KCmZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgd2FybigiRXJyb3IgaW4gIiArIGluZm8gKyAiOiBcIiIgKyBlcnIudG9TdHJpbmcoKSArICJcIiIsIHZtKTsKICB9CgogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsKICB9IGVsc2UgewogICAgdGhyb3cgZXJyOwogIH0KfQoKdmFyIHZ1ZURlcGVuZGVuY3kgPSB1bmRlZmluZWQ7Cgp0cnkgewogIHZhciByZXF1aXJlZFZ1ZSA9IHJlcXVpcmUoJ3Z1ZScpOwoKICBpZiAocmVxdWlyZWRWdWUgJiYgaXNWdWUocmVxdWlyZWRWdWUpKSB7CiAgICB2dWVEZXBlbmRlbmN5ID0gcmVxdWlyZWRWdWU7CiAgfSBlbHNlIGlmIChyZXF1aXJlZFZ1ZSAmJiAnZGVmYXVsdCcgaW4gcmVxdWlyZWRWdWUgJiYgaXNWdWUocmVxdWlyZWRWdWVbImRlZmF1bHQiXSkpIHsKICAgIHZ1ZURlcGVuZGVuY3kgPSByZXF1aXJlZFZ1ZVsiZGVmYXVsdCJdOwogIH0KfSBjYXRjaCAoX2EpIHsvLyBub3QgYXZhaWxhYmxlCn0KCnZhciB2dWVDb25zdHJ1Y3RvciA9IG51bGw7CnZhciBjdXJyZW50SW5zdGFuY2UgPSBudWxsOwp2YXIgUGx1Z2luSW5zdGFsbGVkRmxhZyA9ICdfX2NvbXBvc2l0aW9uX2FwaV9pbnN0YWxsZWRfXyc7CgpmdW5jdGlvbiBpc1Z1ZShvYmopIHsKICByZXR1cm4gb2JqICYmIHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicgJiYgb2JqLm5hbWUgPT09ICdWdWUnOwp9CgpmdW5jdGlvbiBpc1Z1ZVJlZ2lzdGVyZWQoVnVlKSB7CiAgcmV0dXJuIGhhc093bihWdWUsIFBsdWdpbkluc3RhbGxlZEZsYWcpOwp9CgpmdW5jdGlvbiBnZXRWdWVDb25zdHJ1Y3RvcigpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0KHZ1ZUNvbnN0cnVjdG9yLCAibXVzdCBjYWxsIFZ1ZS51c2UoVnVlQ29tcG9zaXRpb25BUEkpIGJlZm9yZSB1c2luZyBhbnkgZnVuY3Rpb24uIik7CiAgfQoKICByZXR1cm4gdnVlQ29uc3RydWN0b3I7Cn0gLy8gcmV0dXJucyByZWdpc3RlcmVkIHZ1ZSBvciBgdnVlYCBkZXBlbmRlbmN5CgoKZnVuY3Rpb24gZ2V0UmVnaXN0ZXJlZFZ1ZU9yRGVmYXVsdCgpIHsKICB2YXIgY29uc3RydWN0b3IgPSB2dWVDb25zdHJ1Y3RvciB8fCB2dWVEZXBlbmRlbmN5OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgYXNzZXJ0KGNvbnN0cnVjdG9yLCAiTm8gdnVlIGRlcGVuZGVuY3kgZm91bmQuIik7CiAgfQoKICByZXR1cm4gY29uc3RydWN0b3I7Cn0KCmZ1bmN0aW9uIHNldFZ1ZUNvbnN0cnVjdG9yKFZ1ZSkgewogIC8vIEB0cy1pZ25vcmUKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB2dWVDb25zdHJ1Y3RvciAmJiBWdWUuX19wcm90b19fICE9PSB2dWVDb25zdHJ1Y3Rvci5fX3Byb3RvX18pIHsKICAgIHdhcm4oJ1t2dWUtY29tcG9zaXRpb24tYXBpXSBhbm90aGVyIGluc3RhbmNlIG9mIFZ1ZSBpbnN0YWxsZWQnKTsKICB9CgogIHZ1ZUNvbnN0cnVjdG9yID0gVnVlOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUsIFBsdWdpbkluc3RhbGxlZEZsYWcsIHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgdmFsdWU6IHRydWUKICB9KTsKfQoKZnVuY3Rpb24gc2V0Q3VycmVudEluc3RhbmNlKHZtKSB7CiAgLy8gY3VycmVudEluc3RhbmNlPy4kc2NvcGVkU2xvdHMKICBjdXJyZW50SW5zdGFuY2UgPSB2bTsKfQoKZnVuY3Rpb24gZ2V0Q3VycmVudFZ1ZTJJbnN0YW5jZSgpIHsKICByZXR1cm4gY3VycmVudEluc3RhbmNlOwp9CgpmdW5jdGlvbiBnZXRDdXJyZW50SW5zdGFuY2UoKSB7CiAgaWYgKGN1cnJlbnRJbnN0YW5jZSkgewogICAgcmV0dXJuIHRvVnVlM0NvbXBvbmVudEluc3RhbmNlKGN1cnJlbnRJbnN0YW5jZSk7CiAgfQoKICByZXR1cm4gbnVsbDsKfQoKdmFyIGluc3RhbmNlTWFwQ2FjaGUgPSBuZXcgV2Vha01hcCgpOwoKZnVuY3Rpb24gdG9WdWUzQ29tcG9uZW50SW5zdGFuY2UodnVlMkluc3RhbmNlKSB7CiAgaWYgKGluc3RhbmNlTWFwQ2FjaGUuaGFzKHZ1ZTJJbnN0YW5jZSkpIHsKICAgIHJldHVybiBpbnN0YW5jZU1hcENhY2hlLmdldCh2dWUySW5zdGFuY2UpOwogIH0KCiAgdmFyIGluc3RhbmNlID0gewogICAgcHJveHk6IHZ1ZTJJbnN0YW5jZSwKICAgIHVwZGF0ZTogdnVlMkluc3RhbmNlLiRmb3JjZVVwZGF0ZSwKICAgIHVpZDogdnVlMkluc3RhbmNlLl91aWQsCiAgICAvLyAkZW1pdCBpcyBkZWZpbmVkIG9uIHByb3RvdHlwZSBhbmQgaXQgZXhwZWN0ZWQgdG8gYmUgYm91bmQKICAgIGVtaXQ6IHZ1ZTJJbnN0YW5jZS4kZW1pdC5iaW5kKHZ1ZTJJbnN0YW5jZSksCiAgICBwYXJlbnQ6IG51bGwsCiAgICByb290OiBudWxsCiAgfTsgLy8gbWFwIHZtLiRwcm9wcyA9CgogIHZhciBpbnN0YW5jZVByb3BzID0gWydkYXRhJywgJ3Byb3BzJywgJ2F0dHJzJywgJ3JlZnMnLCAndm5vZGUnLCAnc2xvdHMnXTsKICBpbnN0YW5jZVByb3BzLmZvckVhY2goZnVuY3Rpb24gKHByb3ApIHsKICAgIHByb3h5KGluc3RhbmNlLCBwcm9wLCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB2dWUySW5zdGFuY2VbIiQiICsgcHJvcF07CiAgICAgIH0KICAgIH0pOwogIH0pOwogIHByb3h5KGluc3RhbmNlLCAnaXNNb3VudGVkJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgcHJpdmF0ZSBhcGkKICAgICAgcmV0dXJuIHZ1ZTJJbnN0YW5jZS5faXNNb3VudGVkOwogICAgfQogIH0pOwogIHByb3h5KGluc3RhbmNlLCAnaXNVbm1vdW50ZWQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBwcml2YXRlIGFwaQogICAgICByZXR1cm4gdnVlMkluc3RhbmNlLl9pc0Rlc3Ryb3llZDsKICAgIH0KICB9KTsKICBwcm94eShpbnN0YW5jZSwgJ2lzRGVhY3RpdmF0ZWQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBwcml2YXRlIGFwaQogICAgICByZXR1cm4gdnVlMkluc3RhbmNlLl9pbmFjdGl2ZTsKICAgIH0KICB9KTsKICBwcm94eShpbnN0YW5jZSwgJ2VtaXR0ZWQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBwcml2YXRlIGFwaQogICAgICByZXR1cm4gdnVlMkluc3RhbmNlLl9ldmVudHM7CiAgICB9CiAgfSk7CiAgaW5zdGFuY2VNYXBDYWNoZS5zZXQodnVlMkluc3RhbmNlLCBpbnN0YW5jZSk7CgogIGlmICh2dWUySW5zdGFuY2UuJHBhcmVudCkgewogICAgaW5zdGFuY2UucGFyZW50ID0gdG9WdWUzQ29tcG9uZW50SW5zdGFuY2UodnVlMkluc3RhbmNlLiRwYXJlbnQpOwogIH0KCiAgaWYgKHZ1ZTJJbnN0YW5jZS4kcm9vdCkgewogICAgaW5zdGFuY2Uucm9vdCA9IHRvVnVlM0NvbXBvbmVudEluc3RhbmNlKHZ1ZTJJbnN0YW5jZS4kcm9vdCk7CiAgfQoKICByZXR1cm4gaW5zdGFuY2U7Cn0KCmZ1bmN0aW9uIGN1cnJlbnRWTUluRm4oaG9vaykgewogIHZhciB2bSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhdm0pIHsKICAgIHdhcm4oaG9vayArICIgaXMgY2FsbGVkIHdoZW4gdGhlcmUgaXMgbm8gYWN0aXZlIGNvbXBvbmVudCBpbnN0YW5jZSB0byBiZSAiICsgImFzc29jaWF0ZWQgd2l0aC4gIiArICJMaWZlY3ljbGUgaW5qZWN0aW9uIEFQSXMgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgZXhlY3V0aW9uIG9mIHNldHVwKCkuIik7CiAgfQoKICByZXR1cm4gdm0gPT09IG51bGwgfHwgdm0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHZtLnByb3h5Owp9CgpmdW5jdGlvbiBkZWZpbmVDb21wb25lbnRJbnN0YW5jZShDdG9yLCBvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgb3B0aW9ucyA9IHt9OwogIH0KCiAgdmFyIHNpbGVudCA9IEN0b3IuY29uZmlnLnNpbGVudDsKICBDdG9yLmNvbmZpZy5zaWxlbnQgPSB0cnVlOwogIHZhciB2bSA9IG5ldyBDdG9yKG9wdGlvbnMpOwogIEN0b3IuY29uZmlnLnNpbGVudCA9IHNpbGVudDsKICByZXR1cm4gdm07Cn0KCmZ1bmN0aW9uIGlzQ29tcG9uZW50SW5zdGFuY2Uob2JqKSB7CiAgdmFyIFZ1ZSA9IGdldFZ1ZUNvbnN0cnVjdG9yKCk7CiAgcmV0dXJuIFZ1ZSAmJiBvYmogaW5zdGFuY2VvZiBWdWU7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVNsb3RQcm94eSh2bSwgc2xvdE5hbWUpIHsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgewogICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICB9CgogICAgaWYgKCF2bS4kc2NvcGVkU2xvdHNbc2xvdE5hbWVdKSB7CiAgICAgIHJldHVybiB3YXJuKCJzbG90cy4iICsgc2xvdE5hbWUgKyAiKCkgZ290IGNhbGxlZCBvdXRzaWRlIG9mIHRoZSBcInJlbmRlcigpXCIgc2NvcGUiLCB2bSk7CiAgICB9CgogICAgcmV0dXJuIHZtLiRzY29wZWRTbG90c1tzbG90TmFtZV0uYXBwbHkodm0sIGFyZ3MpOwogIH07Cn0KCmZ1bmN0aW9uIHJlc29sdmVTbG90cyhzbG90cywgbm9ybWFsU2xvdHMpIHsKICB2YXIgcmVzOwoKICBpZiAoIXNsb3RzKSB7CiAgICByZXMgPSB7fTsKICB9IGVsc2UgaWYgKHNsb3RzLl9ub3JtYWxpemVkKSB7CiAgICAvLyBmYXN0IHBhdGggMTogY2hpbGQgY29tcG9uZW50IHJlLXJlbmRlciBvbmx5LCBwYXJlbnQgZGlkIG5vdCBjaGFuZ2UKICAgIHJldHVybiBzbG90cy5fbm9ybWFsaXplZDsKICB9IGVsc2UgewogICAgcmVzID0ge307CgogICAgZm9yICh2YXIga2V5IGluIHNsb3RzKSB7CiAgICAgIGlmIChzbG90c1trZXldICYmIGtleVswXSAhPT0gJyQnKSB7CiAgICAgICAgcmVzW2tleV0gPSB0cnVlOwogICAgICB9CiAgICB9CiAgfSAvLyBleHBvc2Ugbm9ybWFsIHNsb3RzIG9uIHNjb3BlZFNsb3RzCgoKICBmb3IgKHZhciBrZXkgaW4gbm9ybWFsU2xvdHMpIHsKICAgIGlmICghKGtleSBpbiByZXMpKSB7CiAgICAgIHJlc1trZXldID0gdHJ1ZTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCnZhciB2dWVJbnRlcm5hbENsYXNzZXM7Cgp2YXIgZ2V0VnVlSW50ZXJuYWxDbGFzc2VzID0gZnVuY3Rpb24gZ2V0VnVlSW50ZXJuYWxDbGFzc2VzKCkgewogIGlmICghdnVlSW50ZXJuYWxDbGFzc2VzKSB7CiAgICB2YXIgdm0gPSBkZWZpbmVDb21wb25lbnRJbnN0YW5jZShnZXRWdWVDb25zdHJ1Y3RvcigpLCB7CiAgICAgIGNvbXB1dGVkOiB7CiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsgLy8gdG8gZ2V0IFdhdGNoZXIgY2xhc3MKCiAgICB2YXIgV2F0Y2hlciA9IHZtLl9jb21wdXRlZFdhdGNoZXJzLnZhbHVlLmNvbnN0cnVjdG9yOyAvLyB0byBnZXQgRGVwIGNsYXNzCgogICAgdmFyIERlcCA9IHZtLl9kYXRhLl9fb2JfXy5kZXAuY29uc3RydWN0b3I7CiAgICB2dWVJbnRlcm5hbENsYXNzZXMgPSB7CiAgICAgIFdhdGNoZXI6IFdhdGNoZXIsCiAgICAgIERlcDogRGVwCiAgICB9OwogICAgdm0uJGRlc3Ryb3koKTsKICB9CgogIHJldHVybiB2dWVJbnRlcm5hbENsYXNzZXM7Cn07Ci8qISAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKg0KQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uDQoNClBlcm1pc3Npb24gdG8gdXNlLCBjb3B5LCBtb2RpZnksIGFuZC9vciBkaXN0cmlidXRlIHRoaXMgc29mdHdhcmUgZm9yIGFueQ0KcHVycG9zZSB3aXRoIG9yIHdpdGhvdXQgZmVlIGlzIGhlcmVieSBncmFudGVkLg0KDQpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiBBTkQgVEhFIEFVVEhPUiBESVNDTEFJTVMgQUxMIFdBUlJBTlRJRVMgV0lUSA0KUkVHQVJEIFRPIFRISVMgU09GVFdBUkUgSU5DTFVESU5HIEFMTCBJTVBMSUVEIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZDQpBTkQgRklUTkVTUy4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUiBCRSBMSUFCTEUgRk9SIEFOWSBTUEVDSUFMLCBESVJFQ1QsDQpJTkRJUkVDVCwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTIE9SIEFOWSBEQU1BR0VTIFdIQVRTT0VWRVIgUkVTVUxUSU5HIEZST00NCkxPU1MgT0YgVVNFLCBEQVRBIE9SIFBST0ZJVFMsIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBORUdMSUdFTkNFIE9SDQpPVEhFUiBUT1JUSU9VUyBBQ1RJT04sIEFSSVNJTkcgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgVVNFIE9SDQpQRVJGT1JNQU5DRSBPRiBUSElTIFNPRlRXQVJFLg0KKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogKi8KCgp2YXIgX2Fzc2lnbiA9IGZ1bmN0aW9uIF9fYXNzaWduKCkgewogIF9hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uIF9fYXNzaWduKHQpIHsKICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICBzID0gYXJndW1lbnRzW2ldOwoKICAgICAgZm9yICh2YXIgcCBpbiBzKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSkgdFtwXSA9IHNbcF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdDsKICB9OwoKICByZXR1cm4gX2Fzc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKZnVuY3Rpb24gX192YWx1ZXMobykgewogIHZhciBzID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuaXRlcmF0b3IsCiAgICAgIG0gPSBzICYmIG9bc10sCiAgICAgIGkgPSAwOwogIGlmIChtKSByZXR1cm4gbS5jYWxsKG8pOwogIGlmIChvICYmIHR5cGVvZiBvLmxlbmd0aCA9PT0gIm51bWJlciIpIHJldHVybiB7CiAgICBuZXh0OiBmdW5jdGlvbiBuZXh0KCkgewogICAgICBpZiAobyAmJiBpID49IG8ubGVuZ3RoKSBvID0gdm9pZCAwOwogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBvICYmIG9baSsrXSwKICAgICAgICBkb25lOiAhbwogICAgICB9OwogICAgfQogIH07CiAgdGhyb3cgbmV3IFR5cGVFcnJvcihzID8gIk9iamVjdCBpcyBub3QgaXRlcmFibGUuIiA6ICJTeW1ib2wuaXRlcmF0b3IgaXMgbm90IGRlZmluZWQuIik7Cn0KCmZ1bmN0aW9uIF9fcmVhZChvLCBuKSB7CiAgdmFyIG0gPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9bU3ltYm9sLml0ZXJhdG9yXTsKICBpZiAoIW0pIHJldHVybiBvOwogIHZhciBpID0gbS5jYWxsKG8pLAogICAgICByLAogICAgICBhciA9IFtdLAogICAgICBlOwoKICB0cnkgewogICAgd2hpbGUgKChuID09PSB2b2lkIDAgfHwgbi0tID4gMCkgJiYgIShyID0gaS5uZXh0KCkpLmRvbmUpIHsKICAgICAgYXIucHVzaChyLnZhbHVlKTsKICAgIH0KICB9IGNhdGNoIChlcnJvcikgewogICAgZSA9IHsKICAgICAgZXJyb3I6IGVycm9yCiAgICB9OwogIH0gZmluYWxseSB7CiAgICB0cnkgewogICAgICBpZiAociAmJiAhci5kb25lICYmIChtID0gaVsicmV0dXJuIl0pKSBtLmNhbGwoaSk7CiAgICB9IGZpbmFsbHkgewogICAgICBpZiAoZSkgdGhyb3cgZS5lcnJvcjsKICAgIH0KICB9CgogIHJldHVybiBhcjsKfQoKZnVuY3Rpb24gX19zcHJlYWQoKSB7CiAgZm9yICh2YXIgYXIgPSBbXSwgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgIGFyID0gYXIuY29uY2F0KF9fcmVhZChhcmd1bWVudHNbaV0pKTsKICB9CgogIHJldHVybiBhcjsKfQoKZnVuY3Rpb24gY3JlYXRlU3ltYm9sKG5hbWUpIHsKICByZXR1cm4gaGFzU3ltYm9sID8gU3ltYm9sWyJmb3IiXShuYW1lKSA6IG5hbWU7Cn0KCnZhciBXYXRjaGVyUHJlRmx1c2hRdWV1ZUtleSA9IGNyZWF0ZVN5bWJvbCgnY29tcG9zaXRpb24tYXBpLnByZUZsdXNoUXVldWUnKTsKdmFyIFdhdGNoZXJQb3N0Rmx1c2hRdWV1ZUtleSA9IGNyZWF0ZVN5bWJvbCgnY29tcG9zaXRpb24tYXBpLnBvc3RGbHVzaFF1ZXVlJyk7IC8vIG11c3QgYmUgYSBzdHJpbmcsIHN5bWJvbCBrZXkgaXMgaWdub3JlZCBpbiByZWFjdGl2ZQoKdmFyIFJlZktleSA9ICdjb21wb3NpdGlvbi1hcGkucmVmS2V5JzsKdmFyIGFjY2Vzc01vZGlmaWVkU2V0ID0gbmV3IFdlYWtNYXAoKTsKdmFyIHJhd1NldCA9IG5ldyBXZWFrTWFwKCk7CnZhciByZWFkb25seVNldCA9IG5ldyBXZWFrTWFwKCk7Cgp2YXIgUmVmSW1wbCA9Ci8qKiBAY2xhc3MgKi8KZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIFJlZkltcGwoX2EpIHsKICAgIHZhciBnZXQgPSBfYS5nZXQsCiAgICAgICAgc2V0ID0gX2Euc2V0OwogICAgcHJveHkodGhpcywgJ3ZhbHVlJywgewogICAgICBnZXQ6IGdldCwKICAgICAgc2V0OiBzZXQKICAgIH0pOwogIH0KCiAgcmV0dXJuIFJlZkltcGw7Cn0oKTsKCmZ1bmN0aW9uIGNyZWF0ZVJlZihvcHRpb25zLCByZWFkb25seSkgewogIHZhciByID0gbmV3IFJlZkltcGwob3B0aW9ucyk7IC8vIHNlYWwgdGhlIHJlZiwgdGhpcyBjb3VsZCBwcmV2ZW50IHJlZiBmcm9tIGJlaW5nIG9ic2VydmVkCiAgLy8gSXQncyBzYWZlIHRvIHNlYWwgdGhlIHJlZiwgc2luY2Ugd2UgcmVhbGx5IHNob3VsZG4ndCBleHRlbmQgaXQuCiAgLy8gcmVsYXRlZCBpc3N1ZXM6ICM3OQoKICB2YXIgc2VhbGVkID0gT2JqZWN0LnNlYWwocik7CiAgcmVhZG9ubHlTZXQuc2V0KHNlYWxlZCwgdHJ1ZSk7CiAgcmV0dXJuIHNlYWxlZDsKfQoKZnVuY3Rpb24gcmVmKHJhdykgewogIHZhciBfYTsKCiAgaWYgKGlzUmVmKHJhdykpIHsKICAgIHJldHVybiByYXc7CiAgfQoKICB2YXIgdmFsdWUgPSByZWFjdGl2ZSgoX2EgPSB7fSwgX2FbUmVmS2V5XSA9IHJhdywgX2EpKTsKICByZXR1cm4gY3JlYXRlUmVmKHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdmFsdWVbUmVmS2V5XTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2KSB7CiAgICAgIHJldHVybiB2YWx1ZVtSZWZLZXldID0gdjsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gaXNSZWYodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBSZWZJbXBsOwp9CgpmdW5jdGlvbiB1bnJlZihyZWYpIHsKICByZXR1cm4gaXNSZWYocmVmKSA/IHJlZi52YWx1ZSA6IHJlZjsKfQoKZnVuY3Rpb24gdG9SZWZzKG9iaikgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFpc1JlYWN0aXZlKG9iaikpIHsKICAgIHdhcm4oInRvUmVmcygpIGV4cGVjdHMgYSByZWFjdGl2ZSBvYmplY3QgYnV0IHJlY2VpdmVkIGEgcGxhaW4gb25lLiIpOwogIH0KCiAgaWYgKCFpc1BsYWluT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgdmFyIHJldCA9IHt9OwoKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICByZXRba2V5XSA9IHRvUmVmKG9iaiwga2V5KTsKICB9CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGN1c3RvbVJlZihmYWN0b3J5KSB7CiAgdmFyIHZlcnNpb24gPSByZWYoMCk7CiAgcmV0dXJuIGNyZWF0ZVJlZihmYWN0b3J5KGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB2b2lkIHZlcnNpb24udmFsdWU7CiAgfSwgZnVuY3Rpb24gKCkgewogICAgKyt2ZXJzaW9uLnZhbHVlOwogIH0pKTsKfQoKZnVuY3Rpb24gdG9SZWYob2JqZWN0LCBrZXkpIHsKICB2YXIgdiA9IG9iamVjdFtrZXldOwogIGlmIChpc1JlZih2KSkgcmV0dXJuIHY7CiAgcmV0dXJuIGNyZWF0ZVJlZih7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIG9iamVjdFtrZXldOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHYpIHsKICAgICAgcmV0dXJuIG9iamVjdFtrZXldID0gdjsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gc2hhbGxvd1JlZihyYXcpIHsKICB2YXIgX2E7CgogIGlmIChpc1JlZihyYXcpKSB7CiAgICByZXR1cm4gcmF3OwogIH0KCiAgdmFyIHZhbHVlID0gc2hhbGxvd1JlYWN0aXZlKChfYSA9IHt9LCBfYVtSZWZLZXldID0gcmF3LCBfYSkpOwogIHJldHVybiBjcmVhdGVSZWYoewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB2YWx1ZVtSZWZLZXldOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHYpIHsKICAgICAgcmV0dXJuIHZhbHVlW1JlZktleV0gPSB2OwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiB0cmlnZ2VyUmVmKHZhbHVlKSB7CiAgaWYgKCFpc1JlZih2YWx1ZSkpIHJldHVybjsKICB2YWx1ZS52YWx1ZSA9IHZhbHVlLnZhbHVlOwp9CgpmdW5jdGlvbiBwcm94eVJlZnMob2JqZWN0V2l0aFJlZnMpIHsKICB2YXIgX2EsIGVfMSwgX2I7CgogIGlmIChpc1JlYWN0aXZlKG9iamVjdFdpdGhSZWZzKSkgewogICAgcmV0dXJuIG9iamVjdFdpdGhSZWZzOwogIH0KCiAgdmFyIHZhbHVlID0gcmVhY3RpdmUoKF9hID0ge30sIF9hW1JlZktleV0gPSBvYmplY3RXaXRoUmVmcywgX2EpKTsKCiAgdmFyIF9sb29wXzEgPSBmdW5jdGlvbiBfbG9vcF8xKGtleSkgewogICAgcHJveHkodmFsdWUsIGtleSwgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICBpZiAoaXNSZWYodmFsdWVba2V5XSkpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZVtrZXldLnZhbHVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlW2tleV07CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KHYpIHsKICAgICAgICBpZiAoaXNSZWYodmFsdWVba2V5XSkpIHsKICAgICAgICAgIHJldHVybiB2YWx1ZVtrZXldLnZhbHVlID0gdW5yZWYodik7CiAgICAgICAgfQoKICAgICAgICB2YWx1ZVtrZXldID0gdW5yZWYodik7CiAgICAgIH0KICAgIH0pOwogIH07CgogIHRyeSB7CiAgICBmb3IgKHZhciBfYyA9IF9fdmFsdWVzKE9iamVjdC5rZXlzKG9iamVjdFdpdGhSZWZzKSksIF9kID0gX2MubmV4dCgpOyAhX2QuZG9uZTsgX2QgPSBfYy5uZXh0KCkpIHsKICAgICAgdmFyIGtleSA9IF9kLnZhbHVlOwoKICAgICAgX2xvb3BfMShrZXkpOwogICAgfQogIH0gY2F0Y2ggKGVfMV8xKSB7CiAgICBlXzEgPSB7CiAgICAgIGVycm9yOiBlXzFfMQogICAgfTsKICB9IGZpbmFsbHkgewogICAgdHJ5IHsKICAgICAgaWYgKF9kICYmICFfZC5kb25lICYmIChfYiA9IF9jWyJyZXR1cm4iXSkpIF9iLmNhbGwoX2MpOwogICAgfSBmaW5hbGx5IHsKICAgICAgaWYgKGVfMSkgdGhyb3cgZV8xLmVycm9yOwogICAgfQogIH0KCiAgcmV0dXJuIHZhbHVlOwp9CgpmdW5jdGlvbiBpc1JhdyhvYmopIHsKICB2YXIgX2E7CgogIHJldHVybiBCb29sZWFuKChvYmogPT09IG51bGwgfHwgb2JqID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvYmouX19vYl9fKSAmJiAoKF9hID0gb2JqLl9fb2JfXykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLl9fcmF3X18pKTsKfQoKZnVuY3Rpb24gaXNSZWFjdGl2ZShvYmopIHsKICB2YXIgX2E7CgogIHJldHVybiBCb29sZWFuKChvYmogPT09IG51bGwgfHwgb2JqID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvYmouX19vYl9fKSAmJiAhKChfYSA9IG9iai5fX29iX18pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5fX3Jhd19fKSk7Cn0KLyoqDQogKiBQcm94aW5nIHByb3BlcnR5IGFjY2VzcyBvZiB0YXJnZXQuDQogKiBXZSBjYW4gZG8gdW53cmFwcGluZyBhbmQgb3RoZXIgdGhpbmdzIGhlcmUuDQogKi8KCgpmdW5jdGlvbiBzZXR1cEFjY2Vzc0NvbnRyb2wodGFyZ2V0KSB7CiAgaWYgKCFpc1BsYWluT2JqZWN0KHRhcmdldCkgfHwgaXNSYXcodGFyZ2V0KSB8fCBBcnJheS5pc0FycmF5KHRhcmdldCkgfHwgaXNSZWYodGFyZ2V0KSB8fCBpc0NvbXBvbmVudEluc3RhbmNlKHRhcmdldCkgfHwgYWNjZXNzTW9kaWZpZWRTZXQuaGFzKHRhcmdldCkpIHJldHVybjsKICBhY2Nlc3NNb2RpZmllZFNldC5zZXQodGFyZ2V0LCB0cnVlKTsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRhcmdldCk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgZGVmaW5lQWNjZXNzQ29udHJvbCh0YXJnZXQsIGtleXNbaV0pOwogIH0KfQovKioNCiAqIEF1dG8gdW53cmFwcGluZyB3aGVuIGFjY2VzcyBwcm9wZXJ0eQ0KICovCgoKZnVuY3Rpb24gZGVmaW5lQWNjZXNzQ29udHJvbCh0YXJnZXQsIGtleSwgdmFsKSB7CiAgaWYgKGtleSA9PT0gJ19fb2JfXycpIHJldHVybjsKICBpZiAoaXNSYXcodGFyZ2V0W2tleV0pKSByZXR1cm47CiAgdmFyIGdldHRlcjsKICB2YXIgc2V0dGVyOwogIHZhciBwcm9wZXJ0eSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpOwoKICBpZiAocHJvcGVydHkpIHsKICAgIGlmIChwcm9wZXJ0eS5jb25maWd1cmFibGUgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBnZXR0ZXIgPSBwcm9wZXJ0eS5nZXQ7CiAgICBzZXR0ZXIgPSBwcm9wZXJ0eS5zZXQ7CgogICAgaWYgKCghZ2V0dGVyIHx8IHNldHRlcikgJiYKICAgIC8qIG5vdCBvbmx5IGhhdmUgZ2V0dGVyICovCiAgICBhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICAgIHZhbCA9IHRhcmdldFtrZXldOwogICAgfQogIH0KCiAgc2V0dXBBY2Nlc3NDb250cm9sKHZhbCk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXR0ZXJIYW5kbGVyKCkgewogICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbCh0YXJnZXQpIDogdmFsOyAvLyBpZiB0aGUga2V5IGlzIGVxdWFsIHRvIFJlZktleSwgc2tpcCB0aGUgdW53cmFwIGxvZ2ljCgogICAgICBpZiAoa2V5ICE9PSBSZWZLZXkgJiYgaXNSZWYodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0dGVySGFuZGxlcihuZXdWYWwpIHsKICAgICAgaWYgKGdldHRlciAmJiAhc2V0dGVyKSByZXR1cm47CiAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKHRhcmdldCkgOiB2YWw7IC8vIElmIHRoZSBrZXkgaXMgZXF1YWwgdG8gUmVmS2V5LCBza2lwIHRoZSB1bndyYXAgbG9naWMKICAgICAgLy8gSWYgYW5kIG9ubHkgaWYgInZhbHVlIiBpcyByZWYgYW5kICJuZXdWYWwiIGlzIG5vdCBhIHJlZiwKICAgICAgLy8gdGhlIGFzc2lnbm1lbnQgc2hvdWxkIGJlIHByb3hpZWQgdG8gInZhbHVlIiByZWYuCgogICAgICBpZiAoa2V5ICE9PSBSZWZLZXkgJiYgaXNSZWYodmFsdWUpICYmICFpc1JlZihuZXdWYWwpKSB7CiAgICAgICAgdmFsdWUudmFsdWUgPSBuZXdWYWw7CiAgICAgIH0gZWxzZSBpZiAoc2V0dGVyKSB7CiAgICAgICAgc2V0dGVyLmNhbGwodGFyZ2V0LCBuZXdWYWwpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgfQoKICAgICAgc2V0dXBBY2Nlc3NDb250cm9sKG5ld1ZhbCk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIG9ic2VydmUob2JqKSB7CiAgdmFyIFZ1ZSA9IGdldFJlZ2lzdGVyZWRWdWVPckRlZmF1bHQoKTsKICB2YXIgb2JzZXJ2ZWQ7CgogIGlmIChWdWUub2JzZXJ2YWJsZSkgewogICAgb2JzZXJ2ZWQgPSBWdWUub2JzZXJ2YWJsZShvYmopOwogIH0gZWxzZSB7CiAgICB2YXIgdm0gPSBkZWZpbmVDb21wb25lbnRJbnN0YW5jZShWdWUsIHsKICAgICAgZGF0YTogewogICAgICAgICQkc3RhdGU6IG9iagogICAgICB9CiAgICB9KTsKICAgIG9ic2VydmVkID0gdm0uX2RhdGEuJCRzdGF0ZTsKICB9IC8vIGluIFNTUiwgdGhlcmUgaXMgbm8gX19vYl9fLiBNb2NrIGZvciByZWFjdGl2aXR5IGNoZWNrCgoKICBpZiAoIWhhc093bihvYnNlcnZlZCwgJ19fb2JfXycpKSB7CiAgICBkZWYob2JzZXJ2ZWQsICdfX29iX18nLCBtb2NrT2JzZXJ2ZXIob2JzZXJ2ZWQpKTsKICB9CgogIHJldHVybiBvYnNlcnZlZDsKfQoKZnVuY3Rpb24gY3JlYXRlT2JzZXJ2ZXIoKSB7CiAgcmV0dXJuIG9ic2VydmUoe30pLl9fb2JfXzsKfQoKZnVuY3Rpb24gbW9ja09ic2VydmVyKHZhbHVlKSB7CiAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgIHZhbHVlID0ge307CiAgfQoKICByZXR1cm4gewogICAgdmFsdWU6IHZhbHVlLAogICAgZGVwOiB7CiAgICAgIG5vdGlmeTogbm9vcEZuLAogICAgICBkZXBlbmQ6IG5vb3BGbiwKICAgICAgYWRkU3ViOiBub29wRm4sCiAgICAgIHJlbW92ZVN1Yjogbm9vcEZuCiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gc2hhbGxvd1JlYWN0aXZlKG9iaikgewogIHZhciBlXzEsIF9hOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhb2JqKSB7CiAgICB3YXJuKCcic2hhbGxvd1JlYWN0aXZlKCkiIGlzIGNhbGxlZCB3aXRob3V0IHByb3ZpZGUgYW4gIm9iamVjdCIuJyk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIShpc1BsYWluT2JqZWN0KG9iaikgfHwgaXNBcnJheShvYmopKSB8fCBpc1JhdyhvYmopIHx8ICFPYmplY3QuaXNFeHRlbnNpYmxlKG9iaikpIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgb2JzZXJ2ZWQgPSBvYnNlcnZlKHt9KTsKICBzZXR1cEFjY2Vzc0NvbnRyb2wob2JzZXJ2ZWQpOwogIHZhciBvYiA9IG9ic2VydmVkLl9fb2JfXzsKCiAgdmFyIF9sb29wXzEgPSBmdW5jdGlvbiBfbG9vcF8xKGtleSkgewogICAgdmFyIHZhbCA9IG9ialtrZXldOwogICAgdmFyIGdldHRlcjsKICAgIHZhciBzZXR0ZXI7CiAgICB2YXIgcHJvcGVydHkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKCiAgICBpZiAocHJvcGVydHkpIHsKICAgICAgaWYgKHByb3BlcnR5LmNvbmZpZ3VyYWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gImNvbnRpbnVlIjsKICAgICAgfQoKICAgICAgZ2V0dGVyID0gcHJvcGVydHkuZ2V0OwogICAgICBzZXR0ZXIgPSBwcm9wZXJ0eS5zZXQ7CiAgICB9CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9ic2VydmVkLCBrZXksIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldHRlckhhbmRsZXIoKSB7CiAgICAgICAgdmFyIF9hOwoKICAgICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbChvYmopIDogdmFsOwogICAgICAgIChfYSA9IG9iLmRlcCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRlcGVuZCgpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXR0ZXJIYW5kbGVyKG5ld1ZhbCkgewogICAgICAgIHZhciBfYTsKCiAgICAgICAgaWYgKGdldHRlciAmJiAhc2V0dGVyKSByZXR1cm47CgogICAgICAgIGlmIChzZXR0ZXIpIHsKICAgICAgICAgIHNldHRlci5jYWxsKG9iaiwgbmV3VmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFsID0gbmV3VmFsOwogICAgICAgIH0KCiAgICAgICAgKF9hID0gb2IuZGVwKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Eubm90aWZ5KCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIHRyeSB7CiAgICBmb3IgKHZhciBfYiA9IF9fdmFsdWVzKE9iamVjdC5rZXlzKG9iaikpLCBfYyA9IF9iLm5leHQoKTsgIV9jLmRvbmU7IF9jID0gX2IubmV4dCgpKSB7CiAgICAgIHZhciBrZXkgPSBfYy52YWx1ZTsKCiAgICAgIF9sb29wXzEoa2V5KTsKICAgIH0KICB9IGNhdGNoIChlXzFfMSkgewogICAgZV8xID0gewogICAgICBlcnJvcjogZV8xXzEKICAgIH07CiAgfSBmaW5hbGx5IHsKICAgIHRyeSB7CiAgICAgIGlmIChfYyAmJiAhX2MuZG9uZSAmJiAoX2EgPSBfYlsicmV0dXJuIl0pKSBfYS5jYWxsKF9iKTsKICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChlXzEpIHRocm93IGVfMS5lcnJvcjsKICAgIH0KICB9CgogIHJldHVybiBvYnNlcnZlZDsKfQovKioNCiAqIE1ha2Ugb2JqIHJlYWN0aXZpdHkNCiAqLwoKCmZ1bmN0aW9uIHJlYWN0aXZlKG9iaikgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFvYmopIHsKICAgIHdhcm4oJyJyZWFjdGl2ZSgpIiBpcyBjYWxsZWQgd2l0aG91dCBwcm92aWRlIGFuICJvYmplY3QiLicpOyAvLyBAdHMtaWdub3JlCgogICAgcmV0dXJuOwogIH0KCiAgaWYgKCEoaXNQbGFpbk9iamVjdChvYmopIHx8IGlzQXJyYXkob2JqKSkgfHwgaXNSYXcob2JqKSB8fCAhT2JqZWN0LmlzRXh0ZW5zaWJsZShvYmopKSB7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgdmFyIG9ic2VydmVkID0gb2JzZXJ2ZShvYmopOwogIHNldHVwQWNjZXNzQ29udHJvbChvYnNlcnZlZCk7CiAgcmV0dXJuIG9ic2VydmVkOwp9Ci8qKg0KICogTWFrZSBzdXJlIG9iaiBjYW4ndCBiZSBhIHJlYWN0aXZlDQogKi8KCgpmdW5jdGlvbiBtYXJrUmF3KG9iaikgewogIGlmICghKGlzUGxhaW5PYmplY3Qob2JqKSB8fCBpc0FycmF5KG9iaikpIHx8ICFPYmplY3QuaXNFeHRlbnNpYmxlKG9iaikpIHsKICAgIHJldHVybiBvYmo7CiAgfSAvLyBzZXQgdGhlIHZ1ZSBvYnNlcnZhYmxlIGZsYWcgYXQgb2JqCgoKICB2YXIgb2IgPSBjcmVhdGVPYnNlcnZlcigpOwogIG9iLl9fcmF3X18gPSB0cnVlOwogIGRlZihvYmosICdfX29iX18nLCBvYik7IC8vIG1hcmsgYXMgUmF3CgogIHJhd1NldC5zZXQob2JqLCB0cnVlKTsKICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiB0b1JhdyhvYnNlcnZlZCkgewogIHZhciBfYSwgX2I7CgogIGlmIChpc1JhdyhvYnNlcnZlZCkgfHwgIU9iamVjdC5pc0V4dGVuc2libGUob2JzZXJ2ZWQpKSB7CiAgICByZXR1cm4gb2JzZXJ2ZWQ7CiAgfQoKICByZXR1cm4gKChfYiA9IChfYSA9IG9ic2VydmVkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuX19vYl9fKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IudmFsdWUpIHx8IG9ic2VydmVkOwp9CgpmdW5jdGlvbiBpc1JlYWRvbmx5KG9iaikgewogIHJldHVybiByZWFkb25seVNldC5oYXMob2JqKTsKfQovKioNCiAqICoqSW4gQHZ1ZS9jb21wb3NpdGlvbi1hcGksIGByZWFjdGl2ZWAgb25seSBwcm92aWRlcyB0eXBlLWxldmVsIHJlYWRvbmx5IGNoZWNrKioNCiAqDQogKiBDcmVhdGVzIGEgcmVhZG9ubHkgY29weSBvZiB0aGUgb3JpZ2luYWwgb2JqZWN0LiBOb3RlIHRoZSByZXR1cm5lZCBjb3B5IGlzIG5vdA0KICogbWFkZSByZWFjdGl2ZSwgYnV0IGByZWFkb25seWAgY2FuIGJlIGNhbGxlZCBvbiBhbiBhbHJlYWR5IHJlYWN0aXZlIG9iamVjdC4NCiAqLwoKCmZ1bmN0aW9uIHJlYWRvbmx5KHRhcmdldCkgewogIHJldHVybiB0YXJnZXQ7Cn0KCmZ1bmN0aW9uIHNoYWxsb3dSZWFkb25seShvYmopIHsKICB2YXIgZV8xLCBfYTsKCiAgaWYgKCEoaXNQbGFpbk9iamVjdChvYmopIHx8IGlzQXJyYXkob2JqKSkgfHwgIU9iamVjdC5pc0V4dGVuc2libGUob2JqKSkgewogICAgcmV0dXJuIG9iajsKICB9CgogIHZhciByZWFkb25seU9iaiA9IHt9OwogIHZhciBzb3VyY2UgPSByZWFjdGl2ZSh7fSk7CiAgdmFyIG9iID0gc291cmNlLl9fb2JfXzsKCiAgdmFyIF9sb29wXzEgPSBmdW5jdGlvbiBfbG9vcF8xKGtleSkgewogICAgdmFyIHZhbCA9IG9ialtrZXldOwogICAgdmFyIGdldHRlcjsKICAgIHZhciBwcm9wZXJ0eSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwoKICAgIGlmIChwcm9wZXJ0eSkgewogICAgICBpZiAocHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiAiY29udGludWUiOwogICAgICB9CgogICAgICBnZXR0ZXIgPSBwcm9wZXJ0eS5nZXQ7CiAgICB9CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJlYWRvbmx5T2JqLCBrZXksIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBnZXQ6IGZ1bmN0aW9uIGdldHRlckhhbmRsZXIoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKICAgICAgICBvYi5kZXAuZGVwZW5kKCk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2KSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIHdhcm4oIlNldCBvcGVyYXRpb24gb24ga2V5IFwiIiArIGtleSArICJcIiBmYWlsZWQ6IHRhcmdldCBpcyByZWFkb25seS4iKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CgogIHRyeSB7CiAgICBmb3IgKHZhciBfYiA9IF9fdmFsdWVzKE9iamVjdC5rZXlzKG9iaikpLCBfYyA9IF9iLm5leHQoKTsgIV9jLmRvbmU7IF9jID0gX2IubmV4dCgpKSB7CiAgICAgIHZhciBrZXkgPSBfYy52YWx1ZTsKCiAgICAgIF9sb29wXzEoa2V5KTsKICAgIH0KICB9IGNhdGNoIChlXzFfMSkgewogICAgZV8xID0gewogICAgICBlcnJvcjogZV8xXzEKICAgIH07CiAgfSBmaW5hbGx5IHsKICAgIHRyeSB7CiAgICAgIGlmIChfYyAmJiAhX2MuZG9uZSAmJiAoX2EgPSBfYlsicmV0dXJuIl0pKSBfYS5jYWxsKF9iKTsKICAgIH0gZmluYWxseSB7CiAgICAgIGlmIChlXzEpIHRocm93IGVfMS5lcnJvcjsKICAgIH0KICB9CgogIHJlYWRvbmx5U2V0LnNldChyZWFkb25seU9iaiwgdHJ1ZSk7CiAgcmV0dXJuIHJlYWRvbmx5T2JqOwp9Ci8qKg0KICogU2V0IGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBBZGRzIHRoZSBuZXcgcHJvcGVydHksIHRyaWdnZXJzIGNoYW5nZQ0KICogbm90aWZpY2F0aW9uIGFuZCBpbnRlcmNlcHQgaXQncyBzdWJzZXF1ZW50IGFjY2VzcyBpZiB0aGUgcHJvcGVydHkgZG9lc24ndA0KICogYWxyZWFkeSBleGlzdC4NCiAqLwoKCmZ1bmN0aW9uIHNldCh0YXJnZXQsIGtleSwgdmFsKSB7CiAgdmFyIFZ1ZSA9IGdldFZ1ZUNvbnN0cnVjdG9yKCk7CiAgdmFyIF9hID0gVnVlLnV0aWwsCiAgICAgIHdhcm4gPSBfYS53YXJuLAogICAgICBkZWZpbmVSZWFjdGl2ZSA9IF9hLmRlZmluZVJlYWN0aXZlOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3Qgc2V0IHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiICsgdGFyZ2V0KTsKICB9CgogIGlmIChpc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgdGFyZ2V0Lmxlbmd0aCA9IE1hdGgubWF4KHRhcmdldC5sZW5ndGgsIGtleSk7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSwgdmFsKTsKICAgIHJldHVybiB2YWw7CiAgfQoKICBpZiAoa2V5IGluIHRhcmdldCAmJiAhKGtleSBpbiBPYmplY3QucHJvdG90eXBlKSkgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgdmFyIG9iID0gdGFyZ2V0Ll9fb2JfXzsKCiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBhZGRpbmcgcmVhY3RpdmUgcHJvcGVydGllcyB0byBhIFZ1ZSBpbnN0YW5jZSBvciBpdHMgcm9vdCAkZGF0YSAnICsgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicpOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGlmICghb2IpIHsKICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGRlZmluZVJlYWN0aXZlKG9iLnZhbHVlLCBrZXksIHZhbCk7IC8vIElNUE9SVEFOVDogZGVmaW5lIGFjY2VzcyBjb250cm9sIGJlZm9yZSB0cmlnZ2VyIHdhdGNoZXIKCiAgZGVmaW5lQWNjZXNzQ29udHJvbCh0YXJnZXQsIGtleSwgdmFsKTsKICBvYi5kZXAubm90aWZ5KCk7CiAgcmV0dXJuIHZhbDsKfQovKioNCiAqIERlbGV0ZSBhIHByb3BlcnR5IGFuZCB0cmlnZ2VyIGNoYW5nZSBpZiBuZWNlc3NhcnkuDQogKi8KCgpmdW5jdGlvbiBkZWwodGFyZ2V0LCBrZXkpIHsKICB2YXIgVnVlID0gZ2V0VnVlQ29uc3RydWN0b3IoKTsKICB2YXIgd2FybiA9IFZ1ZS51dGlsLndhcm47CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyB0YXJnZXQpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2IgPSB0YXJnZXQuX19vYl9fOwoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGRlbGV0aW5nIHByb3BlcnRpZXMgb24gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJyk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIWhhc093bih0YXJnZXQsIGtleSkpIHsKICAgIHJldHVybjsKICB9CgogIGRlbGV0ZSB0YXJnZXRba2V5XTsKCiAgaWYgKCFvYikgewogICAgcmV0dXJuOwogIH0KCiAgb2IuZGVwLm5vdGlmeSgpOwp9Cgp2YXIgZ2VuTmFtZSA9IGZ1bmN0aW9uIGdlbk5hbWUobmFtZSkgewogIHJldHVybiAib24iICsgKG5hbWVbMF0udG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwp9OwoKZnVuY3Rpb24gY3JlYXRlTGlmZUN5Y2xlKGxpZmVDeWNsZWhvb2spIHsKICByZXR1cm4gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICB2YXIgdm0gPSBjdXJyZW50Vk1JbkZuKGdlbk5hbWUobGlmZUN5Y2xlaG9vaykpOwoKICAgIGlmICh2bSkgewogICAgICBpbmplY3RIb29rT3B0aW9uKGdldFZ1ZUNvbnN0cnVjdG9yKCksIHZtLCBsaWZlQ3ljbGVob29rLCBjYWxsYmFjayk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gaW5qZWN0SG9va09wdGlvbihWdWUsIHZtLCBob29rLCB2YWwpIHsKICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogIHZhciBtZXJnZUZuID0gVnVlLmNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXNbaG9va107CiAgb3B0aW9uc1tob29rXSA9IG1lcmdlRm4ob3B0aW9uc1tob29rXSwgd3JhcEhvb2tDYWxsKHZtLCB2YWwpKTsKfQoKZnVuY3Rpb24gd3JhcEhvb2tDYWxsKHZtLCBmbikgewogIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX2E7CgogICAgdmFyIGFyZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgewogICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICB9CgogICAgdmFyIHByZVZtID0gKF9hID0gZ2V0Q3VycmVudEluc3RhbmNlKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wcm94eTsKICAgIHNldEN1cnJlbnRJbnN0YW5jZSh2bSk7CgogICAgdHJ5IHsKICAgICAgcmV0dXJuIGZuLmFwcGx5KHZvaWQgMCwgX19zcHJlYWQoYXJncykpOwogICAgfSBmaW5hbGx5IHsKICAgICAgc2V0Q3VycmVudEluc3RhbmNlKHByZVZtKTsKICAgIH0KICB9Owp9IC8vIGV4cG9ydCBjb25zdCBvbkNyZWF0ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2NyZWF0ZWQnKTsKCgp2YXIgb25CZWZvcmVNb3VudCA9IGNyZWF0ZUxpZmVDeWNsZSgnYmVmb3JlTW91bnQnKTsKdmFyIG9uTW91bnRlZCA9IGNyZWF0ZUxpZmVDeWNsZSgnbW91bnRlZCcpOwp2YXIgb25CZWZvcmVVcGRhdGUgPSBjcmVhdGVMaWZlQ3ljbGUoJ2JlZm9yZVVwZGF0ZScpOwp2YXIgb25VcGRhdGVkID0gY3JlYXRlTGlmZUN5Y2xlKCd1cGRhdGVkJyk7CnZhciBvbkJlZm9yZVVubW91bnQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2JlZm9yZURlc3Ryb3knKTsKdmFyIG9uVW5tb3VudGVkID0gY3JlYXRlTGlmZUN5Y2xlKCdkZXN0cm95ZWQnKTsKdmFyIG9uRXJyb3JDYXB0dXJlZCA9IGNyZWF0ZUxpZmVDeWNsZSgnZXJyb3JDYXB0dXJlZCcpOwp2YXIgb25BY3RpdmF0ZWQgPSBjcmVhdGVMaWZlQ3ljbGUoJ2FjdGl2YXRlZCcpOwp2YXIgb25EZWFjdGl2YXRlZCA9IGNyZWF0ZUxpZmVDeWNsZSgnZGVhY3RpdmF0ZWQnKTsKdmFyIG9uU2VydmVyUHJlZmV0Y2ggPSBjcmVhdGVMaWZlQ3ljbGUoJ3NlcnZlclByZWZldGNoJyk7CnZhciBmYWxsYmFja1ZNOwoKZnVuY3Rpb24gZmx1c2hQcmVRdWV1ZSgpIHsKICBmbHVzaFF1ZXVlKHRoaXMsIFdhdGNoZXJQcmVGbHVzaFF1ZXVlS2V5KTsKfQoKZnVuY3Rpb24gZmx1c2hQb3N0UXVldWUoKSB7CiAgZmx1c2hRdWV1ZSh0aGlzLCBXYXRjaGVyUG9zdEZsdXNoUXVldWVLZXkpOwp9CgpmdW5jdGlvbiBoYXNXYXRjaEVudih2bSkgewogIHJldHVybiB2bVtXYXRjaGVyUHJlRmx1c2hRdWV1ZUtleV0gIT09IHVuZGVmaW5lZDsKfQoKZnVuY3Rpb24gaW5zdGFsbFdhdGNoRW52KHZtKSB7CiAgdm1bV2F0Y2hlclByZUZsdXNoUXVldWVLZXldID0gW107CiAgdm1bV2F0Y2hlclBvc3RGbHVzaFF1ZXVlS2V5XSA9IFtdOwogIHZtLiRvbignaG9vazpiZWZvcmVVcGRhdGUnLCBmbHVzaFByZVF1ZXVlKTsKICB2bS4kb24oJ2hvb2s6dXBkYXRlZCcsIGZsdXNoUG9zdFF1ZXVlKTsKfQoKZnVuY3Rpb24gZ2V0V2F0Y2hlck9wdGlvbihvcHRpb25zKSB7CiAgcmV0dXJuIF9hc3NpZ24oewogICAgaW1tZWRpYXRlOiBmYWxzZSwKICAgIGRlZXA6IGZhbHNlLAogICAgZmx1c2g6ICdwcmUnCiAgfSwgb3B0aW9ucyk7Cn0KCmZ1bmN0aW9uIGdldFdhdGNoRWZmZWN0T3B0aW9uKG9wdGlvbnMpIHsKICByZXR1cm4gX2Fzc2lnbih7CiAgICBpbW1lZGlhdGU6IHRydWUsCiAgICBkZWVwOiBmYWxzZSwKICAgIGZsdXNoOiAncHJlJwogIH0sIG9wdGlvbnMpOwp9CgpmdW5jdGlvbiBnZXRXYXRjaGVyVk0oKSB7CiAgdmFyIF9hOwoKICB2YXIgdm0gPSAoX2EgPSBnZXRDdXJyZW50SW5zdGFuY2UoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnByb3h5OwoKICBpZiAoIXZtKSB7CiAgICBpZiAoIWZhbGxiYWNrVk0pIHsKICAgICAgZmFsbGJhY2tWTSA9IGRlZmluZUNvbXBvbmVudEluc3RhbmNlKGdldFZ1ZUNvbnN0cnVjdG9yKCkpOwogICAgfQoKICAgIHZtID0gZmFsbGJhY2tWTTsKICB9IGVsc2UgaWYgKCFoYXNXYXRjaEVudih2bSkpIHsKICAgIGluc3RhbGxXYXRjaEVudih2bSk7CiAgfQoKICByZXR1cm4gdm07Cn0KCmZ1bmN0aW9uIGZsdXNoUXVldWUodm0sIGtleSkgewogIHZhciBxdWV1ZSA9IHZtW2tleV07CgogIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBxdWV1ZS5sZW5ndGg7IGluZGV4KyspIHsKICAgIHF1ZXVlW2luZGV4XSgpOwogIH0KCiAgcXVldWUubGVuZ3RoID0gMDsKfQoKZnVuY3Rpb24gcXVldWVGbHVzaEpvYih2bSwgZm4sIG1vZGUpIHsKICAvLyBmbHVzaCBhbGwgd2hlbiBiZWZvcmVVcGRhdGUgYW5kIHVwZGF0ZWQgYXJlIG5vdCBmaXJlZAogIHZhciBmYWxsYmFja0ZsdXNoID0gZnVuY3Rpb24gZmFsbGJhY2tGbHVzaCgpIHsKICAgIHZtLiRuZXh0VGljayhmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh2bVtXYXRjaGVyUHJlRmx1c2hRdWV1ZUtleV0ubGVuZ3RoKSB7CiAgICAgICAgZmx1c2hRdWV1ZSh2bSwgV2F0Y2hlclByZUZsdXNoUXVldWVLZXkpOwogICAgICB9CgogICAgICBpZiAodm1bV2F0Y2hlclBvc3RGbHVzaFF1ZXVlS2V5XS5sZW5ndGgpIHsKICAgICAgICBmbHVzaFF1ZXVlKHZtLCBXYXRjaGVyUG9zdEZsdXNoUXVldWVLZXkpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBzd2l0Y2ggKG1vZGUpIHsKICAgIGNhc2UgJ3ByZSc6CiAgICAgIGZhbGxiYWNrRmx1c2goKTsKICAgICAgdm1bV2F0Y2hlclByZUZsdXNoUXVldWVLZXldLnB1c2goZm4pOwogICAgICBicmVhazsKCiAgICBjYXNlICdwb3N0JzoKICAgICAgZmFsbGJhY2tGbHVzaCgpOwogICAgICB2bVtXYXRjaGVyUG9zdEZsdXNoUXVldWVLZXldLnB1c2goZm4pOwogICAgICBicmVhazsKCiAgICBkZWZhdWx0OgogICAgICBhc3NlcnQoZmFsc2UsICJmbHVzaCBtdXN0IGJlIG9uZSBvZiBbXCJwb3N0XCIsIFwicHJlXCIsIFwic3luY1wiXSwgYnV0IGdvdCAiICsgbW9kZSk7CiAgICAgIGJyZWFrOwogIH0KfQoKZnVuY3Rpb24gY3JlYXRlVnVlV2F0Y2hlcih2bSwgZ2V0dGVyLCBjYWxsYmFjaywgb3B0aW9ucykgewogIHZhciBpbmRleCA9IHZtLl93YXRjaGVycy5sZW5ndGg7IC8vIEB0cy1pZ25vcmU6IHVzZSB1bmRvY3VtZW50ZWQgb3B0aW9ucwoKICB2bS4kd2F0Y2goZ2V0dGVyLCBjYWxsYmFjaywgewogICAgaW1tZWRpYXRlOiBvcHRpb25zLmltbWVkaWF0ZUludm9rZUNhbGxiYWNrLAogICAgZGVlcDogb3B0aW9ucy5kZWVwLAogICAgbGF6eTogb3B0aW9ucy5ub1J1biwKICAgIHN5bmM6IG9wdGlvbnMuc3luYywKICAgIGJlZm9yZTogb3B0aW9ucy5iZWZvcmUKICB9KTsKICByZXR1cm4gdm0uX3dhdGNoZXJzW2luZGV4XTsKfSAvLyBXZSBoYXZlIHRvIG1vbmtleXBhdGNoIHRoZSB0ZWFyZG93biBmdW5jdGlvbiBzbyBWdWUgd2lsbCBydW4KLy8gcnVuQ2xlYW51cCgpIHdoZW4gaXQgdGVhcnMgZG93biB0aGUgd2F0Y2hlciBvbiB1bm1vdW50ZWQuCgoKZnVuY3Rpb24gcGF0Y2hXYXRjaGVyVGVhcmRvd24od2F0Y2hlciwgcnVuQ2xlYW51cCkgewogIHZhciBfdGVhcmRvd24gPSB3YXRjaGVyLnRlYXJkb3duOwoKICB3YXRjaGVyLnRlYXJkb3duID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgewogICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICB9CgogICAgX3RlYXJkb3duLmFwcGx5KHdhdGNoZXIsIGFyZ3MpOwoKICAgIHJ1bkNsZWFudXAoKTsKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVXYXRjaGVyKHZtLCBzb3VyY2UsIGNiLCBvcHRpb25zKSB7CiAgdmFyIF9hOwoKICB2YXIgZmx1c2hNb2RlID0gb3B0aW9ucy5mbHVzaDsKICB2YXIgaXNTeW5jID0gZmx1c2hNb2RlID09PSAnc3luYyc7CiAgdmFyIGNsZWFudXA7CgogIHZhciByZWdpc3RlckNsZWFudXAgPSBmdW5jdGlvbiByZWdpc3RlckNsZWFudXAoZm4pIHsKICAgIGNsZWFudXAgPSBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICB0cnkgewogICAgICAgIGZuKCk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgbG9nRXJyb3IoZXJyb3IsIHZtLCAnb25DbGVhbnVwKCknKTsKICAgICAgfQogICAgfTsKICB9OyAvLyBjbGVhbnVwIGJlZm9yZSBydW5uaW5nIGdldHRlciBhZ2FpbgoKCiAgdmFyIHJ1bkNsZWFudXAgPSBmdW5jdGlvbiBydW5DbGVhbnVwKCkgewogICAgaWYgKGNsZWFudXApIHsKICAgICAgY2xlYW51cCgpOwogICAgICBjbGVhbnVwID0gbnVsbDsKICAgIH0KICB9OwoKICB2YXIgY3JlYXRlU2NoZWR1bGVyID0gZnVuY3Rpb24gY3JlYXRlU2NoZWR1bGVyKGZuKSB7CiAgICBpZiAoaXNTeW5jIHx8CiAgICAvKiB3aXRob3V0IGEgY3VycmVudCBhY3RpdmUgaW5zdGFuY2UsIGlnbm9yZSBwcmV8cG9zdCBtb2RlICovCiAgICB2bSA9PT0gZmFsbGJhY2tWTSkgewogICAgICByZXR1cm4gZm47CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGFyZ3MgPSBbXTsKCiAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldOwogICAgICB9CgogICAgICByZXR1cm4gcXVldWVGbHVzaEpvYih2bSwgZnVuY3Rpb24gKCkgewogICAgICAgIGZuLmFwcGx5KHZvaWQgMCwgX19zcHJlYWQoYXJncykpOwogICAgICB9LCBmbHVzaE1vZGUpOwogICAgfTsKICB9OyAvLyBlZmZlY3Qgd2F0Y2gKCgogIGlmIChjYiA9PT0gbnVsbCkgewogICAgdmFyIHJ1bm5pbmdfMSA9IGZhbHNlOwoKICAgIHZhciBnZXR0ZXJfMSA9IGZ1bmN0aW9uIGdldHRlcl8xKCkgewogICAgICAvLyBwcmV2ZW50aW5nIHRoZSB3YXRjaCBjYWxsYmFjayBiZWluZyBjYWxsIGluIHRoZSBzYW1lIGV4ZWN1dGlvbgogICAgICBpZiAocnVubmluZ18xKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIHJ1bm5pbmdfMSA9IHRydWU7CiAgICAgICAgc291cmNlKHJlZ2lzdGVyQ2xlYW51cCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgcnVubmluZ18xID0gZmFsc2U7CiAgICAgIH0KICAgIH07CgogICAgdmFyIHdhdGNoZXJfMSA9IGNyZWF0ZVZ1ZVdhdGNoZXIodm0sIGdldHRlcl8xLCBub29wRm4sIHsKICAgICAgZGVlcDogb3B0aW9ucy5kZWVwIHx8IGZhbHNlLAogICAgICBzeW5jOiBpc1N5bmMsCiAgICAgIGJlZm9yZTogcnVuQ2xlYW51cAogICAgfSk7CiAgICBwYXRjaFdhdGNoZXJUZWFyZG93bih3YXRjaGVyXzEsIHJ1bkNsZWFudXApOyAvLyBlbmFibGUgdGhlIHdhdGNoZXIgdXBkYXRlCgogICAgd2F0Y2hlcl8xLmxhenkgPSBmYWxzZTsKICAgIHZhciBvcmlnaW5HZXQgPSB3YXRjaGVyXzEuZ2V0LmJpbmQod2F0Y2hlcl8xKTsgLy8gYWx3YXlzIHJ1biB3YXRjaEVmZmVjdAoKICAgIHdhdGNoZXJfMS5nZXQgPSBjcmVhdGVTY2hlZHVsZXIob3JpZ2luR2V0KTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHdhdGNoZXJfMS50ZWFyZG93bigpOwogICAgfTsKICB9CgogIHZhciBkZWVwID0gb3B0aW9ucy5kZWVwOwogIHZhciBnZXR0ZXI7CgogIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZSkpIHsKICAgIGdldHRlciA9IGZ1bmN0aW9uIGdldHRlcigpIHsKICAgICAgcmV0dXJuIHNvdXJjZS5tYXAoZnVuY3Rpb24gKHMpIHsKICAgICAgICByZXR1cm4gaXNSZWYocykgPyBzLnZhbHVlIDogcygpOwogICAgICB9KTsKICAgIH07CiAgfSBlbHNlIGlmIChpc1JlZihzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiBnZXR0ZXIoKSB7CiAgICAgIHJldHVybiBzb3VyY2UudmFsdWU7CiAgICB9OwogIH0gZWxzZSBpZiAoaXNSZWFjdGl2ZShzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBmdW5jdGlvbiBnZXR0ZXIoKSB7CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9OwoKICAgIGRlZXAgPSB0cnVlOwogIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihzb3VyY2UpKSB7CiAgICBnZXR0ZXIgPSBzb3VyY2U7CiAgfSBlbHNlIHsKICAgIGdldHRlciA9IG5vb3BGbjsKICAgIHdhcm4oIkludmFsaWQgd2F0Y2ggc291cmNlOiAiICsgSlNPTi5zdHJpbmdpZnkoc291cmNlKSArICIuXG4gICAgICBBIHdhdGNoIHNvdXJjZSBjYW4gb25seSBiZSBhIGdldHRlci9lZmZlY3QgZnVuY3Rpb24sIGEgcmVmLCBhIHJlYWN0aXZlIG9iamVjdCwgb3IgYW4gYXJyYXkgb2YgdGhlc2UgdHlwZXMuIiwgdm0pOwogIH0KCiAgdmFyIGFwcGx5Q2IgPSBmdW5jdGlvbiBhcHBseUNiKG4sIG8pIHsKICAgIC8vIGNsZWFudXAgYmVmb3JlIHJ1bm5pbmcgY2IgYWdhaW4KICAgIHJ1bkNsZWFudXAoKTsKICAgIGNiKG4sIG8sIHJlZ2lzdGVyQ2xlYW51cCk7CiAgfTsKCiAgdmFyIGNhbGxiYWNrID0gY3JlYXRlU2NoZWR1bGVyKGFwcGx5Q2IpOwoKICBpZiAob3B0aW9ucy5pbW1lZGlhdGUpIHsKICAgIHZhciBvcmlnaW5hbENhbGxiYWNrXzEgPSBjYWxsYmFjazsgLy8gYHNoaWZ0Q2FsbGJhY2tgIGlzIHVzZWQgdG8gaGFuZGxlIHRoZSBmaXJzdCBzeW5jIGVmZmVjdCBydW4uCiAgICAvLyBUaGUgc3Vic2VxdWVudCBjYWxsYmFja3Mgd2lsbCByZWRpcmVjdCB0byBgY2FsbGJhY2tgLgoKICAgIHZhciBfc2hpZnRDYWxsYmFja18gPSBmdW5jdGlvbiBzaGlmdENhbGxiYWNrXzEobiwgbykgewogICAgICBfc2hpZnRDYWxsYmFja18gPSBvcmlnaW5hbENhbGxiYWNrXzE7CiAgICAgIGFwcGx5Q2Iobiwgbyk7CiAgICB9OwoKICAgIGNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2sobiwgbykgewogICAgICBfc2hpZnRDYWxsYmFja18obiwgbyk7CiAgICB9OwogIH0gLy8gQHRzLWlnbm9yZTogdXNlIHVuZG9jdW1lbnRlZCBvcHRpb24gInN5bmMiCgoKICB2YXIgc3RvcCA9IHZtLiR3YXRjaChnZXR0ZXIsIGNhbGxiYWNrLCB7CiAgICBpbW1lZGlhdGU6IG9wdGlvbnMuaW1tZWRpYXRlLAogICAgZGVlcDogZGVlcCwKICAgIHN5bmM6IGlzU3luYwogIH0pOyAvLyBPbmNlIGFnYWluLCB3ZSBoYXZlIHRvIGhhY2sgdGhlIHdhdGNoZXIgZm9yIHByb3BlciB0ZWFyZG93bgoKICB2YXIgd2F0Y2hlciA9IHZtLl93YXRjaGVyc1t2bS5fd2F0Y2hlcnMubGVuZ3RoIC0gMV07IC8vIGlmIHRoZSByZXR1cm4gdmFsdWUgaXMgcmVhY3RpdmUgYW5kIGRlZXA6dHJ1ZQogIC8vIHdhdGNoIGZvciBjaGFuZ2VzLCB0aGlzIG1pZ2h0IGhhcHBlbiB3aGVuIG5ldyBrZXkgaXMgYWRkZWQKCiAgaWYgKGlzUmVhY3RpdmUod2F0Y2hlci52YWx1ZSkgJiYgKChfYSA9IHdhdGNoZXIudmFsdWUuX19vYl9fKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZGVwKSAmJiBkZWVwKSB7CiAgICB3YXRjaGVyLnZhbHVlLl9fb2JfXy5kZXAuYWRkU3ViKHsKICAgICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUoKSB7CiAgICAgICAgLy8gdGhpcyB3aWxsIGZvcmNlIHRoZSBzb3VyY2UgdG8gYmUgcmV2YWx1YXRlZCBhbmQgdGhlIGNhbGxiYWNrCiAgICAgICAgLy8gZXhlY3V0ZWQgaWYgbmVlZGVkCiAgICAgICAgd2F0Y2hlci5ydW4oKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBwYXRjaFdhdGNoZXJUZWFyZG93bih3YXRjaGVyLCBydW5DbGVhbnVwKTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgc3RvcCgpOwogIH07Cn0KCmZ1bmN0aW9uIHdhdGNoRWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogIHZhciBvcHRzID0gZ2V0V2F0Y2hFZmZlY3RPcHRpb24ob3B0aW9ucyk7CiAgdmFyIHZtID0gZ2V0V2F0Y2hlclZNKCk7CiAgcmV0dXJuIGNyZWF0ZVdhdGNoZXIodm0sIGVmZmVjdCwgbnVsbCwgb3B0cyk7Cn0gLy8gaW1wbGVtZW50YXRpb24KCgpmdW5jdGlvbiB3YXRjaChzb3VyY2UsIGNiLCBvcHRpb25zKSB7CiAgdmFyIGNhbGxiYWNrID0gbnVsbDsKCiAgaWYgKHR5cGVvZiBjYiA9PT0gJ2Z1bmN0aW9uJykgewogICAgLy8gc291cmNlIHdhdGNoCiAgICBjYWxsYmFjayA9IGNiOwogIH0gZWxzZSB7CiAgICAvLyBlZmZlY3Qgd2F0Y2gKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHdhcm4oImB3YXRjaChmbiwgb3B0aW9ucz8pYCBzaWduYXR1cmUgaGFzIGJlZW4gbW92ZWQgdG8gYSBzZXBhcmF0ZSBBUEkuICIgKyAiVXNlIGB3YXRjaEVmZmVjdChmbiwgb3B0aW9ucz8pYCBpbnN0ZWFkLiBgd2F0Y2hgIG5vdyBvbmx5ICIgKyAic3VwcG9ydHMgYHdhdGNoKHNvdXJjZSwgY2IsIG9wdGlvbnM/KSBzaWduYXR1cmUuIik7CiAgICB9CgogICAgb3B0aW9ucyA9IGNiOwogICAgY2FsbGJhY2sgPSBudWxsOwogIH0KCiAgdmFyIG9wdHMgPSBnZXRXYXRjaGVyT3B0aW9uKG9wdGlvbnMpOwogIHZhciB2bSA9IGdldFdhdGNoZXJWTSgpOwogIHJldHVybiBjcmVhdGVXYXRjaGVyKHZtLCBzb3VyY2UsIGNhbGxiYWNrLCBvcHRzKTsKfSAvLyBpbXBsZW1lbnQKCgpmdW5jdGlvbiBjb21wdXRlZChvcHRpb25zKSB7CiAgdmFyIF9hOwoKICB2YXIgdm0gPSAoX2EgPSBnZXRDdXJyZW50SW5zdGFuY2UoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnByb3h5OwogIHZhciBnZXQsIHNldDsKCiAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nKSB7CiAgICBnZXQgPSBvcHRpb25zOwogIH0gZWxzZSB7CiAgICBnZXQgPSBvcHRpb25zLmdldDsKICAgIHNldCA9IG9wdGlvbnMuc2V0OwogIH0KCiAgdmFyIGNvbXB1dGVkU2V0dGVyOwogIHZhciBjb21wdXRlZEdldHRlcjsKCiAgaWYgKHZtICYmICF2bS4kaXNTZXJ2ZXIpIHsKICAgIHZhciBfYiA9IGdldFZ1ZUludGVybmFsQ2xhc3NlcygpLAogICAgICAgIFdhdGNoZXJfMSA9IF9iLldhdGNoZXIsCiAgICAgICAgRGVwXzEgPSBfYi5EZXA7CgogICAgdmFyIHdhdGNoZXJfMTsKCiAgICBjb21wdXRlZEdldHRlciA9IGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyKCkgewogICAgICBpZiAoIXdhdGNoZXJfMSkgewogICAgICAgIHdhdGNoZXJfMSA9IG5ldyBXYXRjaGVyXzEodm0sIGdldCwgbm9vcEZuLCB7CiAgICAgICAgICBsYXp5OiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICh3YXRjaGVyXzEuZGlydHkpIHsKICAgICAgICB3YXRjaGVyXzEuZXZhbHVhdGUoKTsKICAgICAgfQoKICAgICAgaWYgKERlcF8xLnRhcmdldCkgewogICAgICAgIHdhdGNoZXJfMS5kZXBlbmQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdhdGNoZXJfMS52YWx1ZTsKICAgIH07CgogICAgY29tcHV0ZWRTZXR0ZXIgPSBmdW5jdGlvbiBjb21wdXRlZFNldHRlcih2KSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFzZXQpIHsKICAgICAgICB3YXJuKCdXcml0ZSBvcGVyYXRpb24gZmFpbGVkOiBjb21wdXRlZCB2YWx1ZSBpcyByZWFkb25seS4nLCB2bSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoc2V0KSB7CiAgICAgICAgc2V0KHYpOwogICAgICB9CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBmYWxsYmFjawogICAgdmFyIGNvbXB1dGVkSG9zdF8xID0gZGVmaW5lQ29tcG9uZW50SW5zdGFuY2UoZ2V0VnVlQ29uc3RydWN0b3IoKSwgewogICAgICBjb21wdXRlZDogewogICAgICAgICQkc3RhdGU6IHsKICAgICAgICAgIGdldDogZ2V0LAogICAgICAgICAgc2V0OiBzZXQKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdm0gJiYgdm0uJG9uKCdob29rOmRlc3Ryb3llZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGNvbXB1dGVkSG9zdF8xLiRkZXN0cm95KCk7CiAgICB9KTsKCiAgICBjb21wdXRlZEdldHRlciA9IGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyKCkgewogICAgICByZXR1cm4gY29tcHV0ZWRIb3N0XzEuJCRzdGF0ZTsKICAgIH07CgogICAgY29tcHV0ZWRTZXR0ZXIgPSBmdW5jdGlvbiBjb21wdXRlZFNldHRlcih2KSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFzZXQpIHsKICAgICAgICB3YXJuKCdXcml0ZSBvcGVyYXRpb24gZmFpbGVkOiBjb21wdXRlZCB2YWx1ZSBpcyByZWFkb25seS4nLCB2bSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb21wdXRlZEhvc3RfMS4kJHN0YXRlID0gdjsKICAgIH07CiAgfQoKICByZXR1cm4gY3JlYXRlUmVmKHsKICAgIGdldDogY29tcHV0ZWRHZXR0ZXIsCiAgICBzZXQ6IGNvbXB1dGVkU2V0dGVyCiAgfSk7Cn0KCnZhciBOT1RfRk9VTkQgPSB7fTsKCmZ1bmN0aW9uIHJlc29sdmVJbmplY3QocHJvdmlkZUtleSwgdm0pIHsKICB2YXIgc291cmNlID0gdm07CgogIHdoaWxlIChzb3VyY2UpIHsKICAgIC8vIEB0cy1pZ25vcmUKICAgIGlmIChzb3VyY2UuX3Byb3ZpZGVkICYmIGhhc093bihzb3VyY2UuX3Byb3ZpZGVkLCBwcm92aWRlS2V5KSkgewogICAgICAvL0B0cy1pZ25vcmUKICAgICAgcmV0dXJuIHNvdXJjZS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICB9CgogICAgc291cmNlID0gc291cmNlLiRwYXJlbnQ7CiAgfQoKICByZXR1cm4gTk9UX0ZPVU5EOwp9CgpmdW5jdGlvbiBwcm92aWRlKGtleSwgdmFsdWUpIHsKICB2YXIgdm0gPSBjdXJyZW50Vk1JbkZuKCdwcm92aWRlJyk7CiAgaWYgKCF2bSkgcmV0dXJuOwoKICBpZiAoIXZtLl9wcm92aWRlZCkgewogICAgdmFyIHByb3ZpZGVDYWNoZV8xID0ge307CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodm0sICdfcHJvdmlkZWQnLCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiBwcm92aWRlQ2FjaGVfMTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodikgewogICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHByb3ZpZGVDYWNoZV8xLCB2KTsKICAgICAgfQogICAgfSk7CiAgfQoKICB2bS5fcHJvdmlkZWRba2V5XSA9IHZhbHVlOwp9CgpmdW5jdGlvbiBpbmplY3Qoa2V5LCBkZWZhdWx0VmFsdWUsIHRyZWF0RGVmYXVsdEFzRmFjdG9yeSkgewogIHZhciBfYTsKCiAgaWYgKHRyZWF0RGVmYXVsdEFzRmFjdG9yeSA9PT0gdm9pZCAwKSB7CiAgICB0cmVhdERlZmF1bHRBc0ZhY3RvcnkgPSBmYWxzZTsKICB9CgogIGlmICgha2V5KSB7CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogIH0KCiAgdmFyIHZtID0gKF9hID0gZ2V0Q3VycmVudEluc3RhbmNlKCkpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wcm94eTsKCiAgaWYgKCF2bSkgewogICAgd2FybigiaW5qZWN0KCkgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgc2V0dXAoKSBvciBmdW5jdGlvbmFsIGNvbXBvbmVudHMuIik7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdmFsID0gcmVzb2x2ZUluamVjdChrZXksIHZtKTsKCiAgaWYgKHZhbCAhPT0gTk9UX0ZPVU5EKSB7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gdW5kZWZpbmVkICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkluamVjdGlvbiBcIiIgKyBTdHJpbmcoa2V5KSArICJcIiBub3QgZm91bmQiLCB2bSk7CiAgfQoKICByZXR1cm4gdHJlYXREZWZhdWx0QXNGYWN0b3J5ICYmIGlzRnVuY3Rpb24oZGVmYXVsdFZhbHVlKSA/IGRlZmF1bHRWYWx1ZSgpIDogZGVmYXVsdFZhbHVlOwp9Cgp2YXIgRU1QVFlfT0JKID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IE9iamVjdC5mcmVlemUoe30pIDoge307Cgp2YXIgdXNlQ3NzTW9kdWxlID0gZnVuY3Rpb24gdXNlQ3NzTW9kdWxlKG5hbWUpIHsKICB2YXIgX2E7CgogIGlmIChuYW1lID09PSB2b2lkIDApIHsKICAgIG5hbWUgPSAnJHN0eWxlJzsKICB9CgogIHZhciBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwoKICBpZiAoIWluc3RhbmNlKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oInVzZUNzc01vZHVsZSBtdXN0IGJlIGNhbGxlZCBpbnNpZGUgc2V0dXAoKSIpOwogICAgcmV0dXJuIEVNUFRZX09CSjsKICB9CgogIHZhciBtb2QgPSAoX2EgPSBpbnN0YW5jZS5wcm94eSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hW25hbWVdOwoKICBpZiAoIW1vZCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJDdXJyZW50IGluc3RhbmNlIGRvZXMgbm90IGhhdmUgQ1NTIG1vZHVsZSBuYW1lZCBcIiIgKyBuYW1lICsgIlwiLiIpOwogICAgcmV0dXJuIEVNUFRZX09CSjsKICB9CgogIHJldHVybiBtb2Q7Cn07Ci8qKg0KICogQGRlcHJlY2F0ZWQgdXNlIGB1c2VDc3NNb2R1bGVgIGluc3RlYWQuDQogKi8KCgp2YXIgdXNlQ1NTTW9kdWxlID0gdXNlQ3NzTW9kdWxlOwoKZnVuY3Rpb24gY3JlYXRlQXBwKHJvb3RDb21wb25lbnQsIHJvb3RQcm9wcykgewogIGlmIChyb290UHJvcHMgPT09IHZvaWQgMCkgewogICAgcm9vdFByb3BzID0gdW5kZWZpbmVkOwogIH0KCiAgdmFyIFYgPSBnZXRWdWVDb25zdHJ1Y3RvcigpOwogIHZhciBtb3VudGVkVk0gPSB1bmRlZmluZWQ7CiAgcmV0dXJuIHsKICAgIGNvbmZpZzogVi5jb25maWcsCiAgICB1c2U6IFYudXNlLmJpbmQoViksCiAgICBtaXhpbjogVi5taXhpbi5iaW5kKFYpLAogICAgY29tcG9uZW50OiBWLmNvbXBvbmVudC5iaW5kKFYpLAogICAgZGlyZWN0aXZlOiBWLmRpcmVjdGl2ZS5iaW5kKFYpLAogICAgbW91bnQ6IGZ1bmN0aW9uIG1vdW50KGVsLCBoeWRyYXRpbmcpIHsKICAgICAgaWYgKCFtb3VudGVkVk0pIHsKICAgICAgICBtb3VudGVkVk0gPSBuZXcgVihfYXNzaWduKHsKICAgICAgICAgIHByb3BzRGF0YTogcm9vdFByb3BzCiAgICAgICAgfSwgcm9vdENvbXBvbmVudCkpOwogICAgICAgIG1vdW50ZWRWTS4kbW91bnQoZWwsIGh5ZHJhdGluZyk7CiAgICAgICAgcmV0dXJuIG1vdW50ZWRWTTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgd2FybigiQXBwIGhhcyBhbHJlYWR5IGJlZW4gbW91bnRlZC5cbiIgKyAiSWYgeW91IHdhbnQgdG8gcmVtb3VudCB0aGUgc2FtZSBhcHAsIG1vdmUgeW91ciBhcHAgY3JlYXRpb24gbG9naWMgIiArICJpbnRvIGEgZmFjdG9yeSBmdW5jdGlvbiBhbmQgY3JlYXRlIGZyZXNoIGFwcCBpbnN0YW5jZXMgZm9yIGVhY2ggIiArICJtb3VudCAtIGUuZy4gYGNvbnN0IGNyZWF0ZU15QXBwID0gKCkgPT4gY3JlYXRlQXBwKEFwcClgIik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbW91bnRlZFZNOwogICAgICB9CiAgICB9LAogICAgdW5tb3VudDogZnVuY3Rpb24gdW5tb3VudCgpIHsKICAgICAgaWYgKG1vdW50ZWRWTSkgewogICAgICAgIG1vdW50ZWRWTS4kZGVzdHJveSgpOwogICAgICAgIG1vdW50ZWRWTSA9IHVuZGVmaW5lZDsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybigiQ2Fubm90IHVubW91bnQgYW4gYXBwIHRoYXQgaXMgbm90IG1vdW50ZWQuIik7CiAgICAgIH0KICAgIH0KICB9Owp9Cgp2YXIgbmV4dFRpY2sgPSBmdW5jdGlvbiBuZXh0VGljaygpIHsKICB2YXIgX2E7CgogIHZhciBhcmdzID0gW107CgogIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7CiAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgfQoKICByZXR1cm4gKF9hID0gZ2V0VnVlQ29uc3RydWN0b3IoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm5leHRUaWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwp9OwoKdmFyIGZhbGxiYWNrQ3JlYXRlRWxlbWVudDsKCnZhciBjcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gY3JlYXRlRWxlbWVudCgpIHsKICB2YXIgX2E7CgogIHZhciBhcmdzID0gW107CgogIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7CiAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgfQoKICB2YXIgaW5zdGFuY2UgPSAoX2EgPSBnZXRDdXJyZW50SW5zdGFuY2UoKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnByb3h5OwoKICBpZiAoIWluc3RhbmNlKSB7CiAgICB3YXJuKCdgY3JlYXRlRWxlbWVudCgpYCBoYXMgYmVlbiBjYWxsZWQgb3V0c2lkZSBvZiByZW5kZXIgZnVuY3Rpb24uJyk7CgogICAgaWYgKCFmYWxsYmFja0NyZWF0ZUVsZW1lbnQpIHsKICAgICAgZmFsbGJhY2tDcmVhdGVFbGVtZW50ID0gZGVmaW5lQ29tcG9uZW50SW5zdGFuY2UoZ2V0VnVlQ29uc3RydWN0b3IoKSkuJGNyZWF0ZUVsZW1lbnQ7CiAgICB9CgogICAgcmV0dXJuIGZhbGxiYWNrQ3JlYXRlRWxlbWVudC5hcHBseShmYWxsYmFja0NyZWF0ZUVsZW1lbnQsIGFyZ3MpOwogIH0KCiAgcmV0dXJuIGluc3RhbmNlLiRjcmVhdGVFbGVtZW50LmFwcGx5KGluc3RhbmNlLCBhcmdzKTsKfTsKLyoqDQogKiBEaXNwbGF5cyBhIHdhcm5pbmcgbWVzc2FnZSAodXNpbmcgY29uc29sZS5lcnJvcikgd2l0aCBhIHN0YWNrIHRyYWNlIGlmIHRoZQ0KICogZnVuY3Rpb24gaXMgY2FsbGVkIGluc2lkZSBvZiBhY3RpdmUgY29tcG9uZW50Lg0KICoNCiAqIEBwYXJhbSBtZXNzYWdlIHdhcm5pbmcgbWVzc2FnZSB0byBiZSBkaXNwbGF5ZWQNCiAqLwoKCmZ1bmN0aW9uIHdhcm4kMShtZXNzYWdlKSB7CiAgdmFyIF9hOwoKICB3YXJuKG1lc3NhZ2UsIChfYSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucHJveHkpOwp9CgpmdW5jdGlvbiBzZXQkMSh2bSwga2V5LCB2YWx1ZSkgewogIHZhciBzdGF0ZSA9IHZtLl9fY29tcG9zaXRpb25fYXBpX3N0YXRlX18gPSB2bS5fX2NvbXBvc2l0aW9uX2FwaV9zdGF0ZV9fIHx8IHt9OwogIHN0YXRlW2tleV0gPSB2YWx1ZTsKfQoKZnVuY3Rpb24gZ2V0KHZtLCBrZXkpIHsKICByZXR1cm4gKHZtLl9fY29tcG9zaXRpb25fYXBpX3N0YXRlX18gfHwge30pW2tleV07Cn0KCnZhciB2bVN0YXRlTWFuYWdlciA9IHsKICBzZXQ6IHNldCQxLAogIGdldDogZ2V0Cn07CgpmdW5jdGlvbiBhc1ZtUHJvcGVydHkodm0sIHByb3BOYW1lLCBwcm9wVmFsdWUpIHsKICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKCiAgaWYgKCEocHJvcE5hbWUgaW4gdm0pICYmICEocHJvcHMgJiYgaGFzT3duKHByb3BzLCBwcm9wTmFtZSkpKSB7CiAgICBpZiAoaXNSZWYocHJvcFZhbHVlKSkgewogICAgICBwcm94eSh2bSwgcHJvcE5hbWUsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHJldHVybiBwcm9wVmFsdWUudmFsdWU7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh2YWwpIHsKICAgICAgICAgIHByb3BWYWx1ZS52YWx1ZSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gQHRzLWlnbm9yZQogICAgICB2bVtwcm9wTmFtZV0gPSBwcm9wVmFsdWU7CiAgICB9CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgLy8gZXhwb3NlIGJpbmRpbmcgdG8gVnVlIERldnRvb2wgYXMgYSBkYXRhIHByb3BlcnR5CiAgICAgIC8vIGRlbGF5IHRoaXMgdW50aWwgc3RhdGUgaGFzIGJlZW4gcmVzb2x2ZWQgdG8gcHJldmVudCByZXBlYXRlZCB3b3JrcwogICAgICB2bS4kbmV4dFRpY2soZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChpc1JlZihwcm9wVmFsdWUpKSB7CiAgICAgICAgICBwcm94eSh2bS5fZGF0YSwgcHJvcE5hbWUsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByb3BWYWx1ZS52YWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsKSB7CiAgICAgICAgICAgICAgcHJvcFZhbHVlLnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdm0uX2RhdGFbcHJvcE5hbWVdID0gcHJvcFZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpZiAocHJvcHMgJiYgaGFzT3duKHByb3BzLCBwcm9wTmFtZSkpIHsKICAgICAgd2FybigiVGhlIHNldHVwIGJpbmRpbmcgcHJvcGVydHkgXCIiICsgcHJvcE5hbWUgKyAiXCIgaXMgYWxyZWFkeSBkZWNsYXJlZCBhcyBhIHByb3AuIiwgdm0pOwogICAgfSBlbHNlIHsKICAgICAgd2FybigiVGhlIHNldHVwIGJpbmRpbmcgcHJvcGVydHkgXCIiICsgcHJvcE5hbWUgKyAiXCIgaXMgYWxyZWFkeSBkZWNsYXJlZC4iLCB2bSk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiB1cGRhdGVUZW1wbGF0ZVJlZih2bSkgewogIHZhciByYXdCaW5kaW5ncyA9IHZtU3RhdGVNYW5hZ2VyLmdldCh2bSwgJ3Jhd0JpbmRpbmdzJykgfHwge307CiAgaWYgKCFyYXdCaW5kaW5ncyB8fCAhT2JqZWN0LmtleXMocmF3QmluZGluZ3MpLmxlbmd0aCkgcmV0dXJuOwogIHZhciByZWZzID0gdm0uJHJlZnM7CiAgdmFyIG9sZFJlZktleXMgPSB2bVN0YXRlTWFuYWdlci5nZXQodm0sICdyZWZzJykgfHwgW107CgogIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBvbGRSZWZLZXlzLmxlbmd0aDsgaW5kZXgrKykgewogICAgdmFyIGtleSA9IG9sZFJlZktleXNbaW5kZXhdOwogICAgdmFyIHNldHVwVmFsdWUgPSByYXdCaW5kaW5nc1trZXldOwoKICAgIGlmICghcmVmc1trZXldICYmIHNldHVwVmFsdWUgJiYgaXNSZWYoc2V0dXBWYWx1ZSkpIHsKICAgICAgc2V0dXBWYWx1ZS52YWx1ZSA9IG51bGw7CiAgICB9CiAgfQoKICB2YXIgbmV3S2V5cyA9IE9iamVjdC5rZXlzKHJlZnMpOwogIHZhciB2YWxpZE5ld0tleXMgPSBbXTsKCiAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IG5ld0tleXMubGVuZ3RoOyBpbmRleCsrKSB7CiAgICB2YXIga2V5ID0gbmV3S2V5c1tpbmRleF07CiAgICB2YXIgc2V0dXBWYWx1ZSA9IHJhd0JpbmRpbmdzW2tleV07CgogICAgaWYgKHJlZnNba2V5XSAmJiBzZXR1cFZhbHVlICYmIGlzUmVmKHNldHVwVmFsdWUpKSB7CiAgICAgIHNldHVwVmFsdWUudmFsdWUgPSByZWZzW2tleV07CiAgICAgIHZhbGlkTmV3S2V5cy5wdXNoKGtleSk7CiAgICB9CiAgfQoKICB2bVN0YXRlTWFuYWdlci5zZXQodm0sICdyZWZzJywgdmFsaWROZXdLZXlzKTsKfQoKZnVuY3Rpb24gcmVzb2x2ZVNjb3BlZFNsb3RzKHZtLCBzbG90c1Byb3h5KSB7CiAgdmFyIHBhcmVudFZOb2RlID0gdm0uJG9wdGlvbnMuX3BhcmVudFZub2RlOwogIGlmICghcGFyZW50Vk5vZGUpIHJldHVybjsKICB2YXIgcHJldlNsb3RzID0gdm1TdGF0ZU1hbmFnZXIuZ2V0KHZtLCAnc2xvdHMnKSB8fCBbXTsKICB2YXIgY3VyU2xvdHMgPSByZXNvbHZlU2xvdHMocGFyZW50Vk5vZGUuZGF0YS5zY29wZWRTbG90cywgdm0uJHNsb3RzKTsgLy8gcmVtb3ZlIHN0YWxlZCBzbG90cwoKICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgcHJldlNsb3RzLmxlbmd0aDsgaW5kZXgrKykgewogICAgdmFyIGtleSA9IHByZXZTbG90c1tpbmRleF07CgogICAgaWYgKCFjdXJTbG90c1trZXldKSB7CiAgICAgIGRlbGV0ZSBzbG90c1Byb3h5W2tleV07CiAgICB9CiAgfSAvLyBwcm94eSBmcmVzaCBzbG90cwoKCiAgdmFyIHNsb3ROYW1lcyA9IE9iamVjdC5rZXlzKGN1clNsb3RzKTsKCiAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHNsb3ROYW1lcy5sZW5ndGg7IGluZGV4KyspIHsKICAgIHZhciBrZXkgPSBzbG90TmFtZXNbaW5kZXhdOwoKICAgIGlmICghc2xvdHNQcm94eVtrZXldKSB7CiAgICAgIHNsb3RzUHJveHlba2V5XSA9IGNyZWF0ZVNsb3RQcm94eSh2bSwga2V5KTsKICAgIH0KICB9CgogIHZtU3RhdGVNYW5hZ2VyLnNldCh2bSwgJ3Nsb3RzJywgc2xvdE5hbWVzKTsKfQoKZnVuY3Rpb24gYWN0aXZhdGVDdXJyZW50SW5zdGFuY2Uodm0sIGZuLCBvbkVycm9yKSB7CiAgdmFyIHByZVZtID0gZ2V0Q3VycmVudFZ1ZTJJbnN0YW5jZSgpOwogIHNldEN1cnJlbnRJbnN0YW5jZSh2bSk7CgogIHRyeSB7CiAgICByZXR1cm4gZm4odm0pOwogIH0gY2F0Y2ggKGVycikgewogICAgaWYgKG9uRXJyb3IpIHsKICAgICAgb25FcnJvcihlcnIpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgZXJyOwogICAgfQogIH0gZmluYWxseSB7CiAgICBzZXRDdXJyZW50SW5zdGFuY2UocHJlVm0pOwogIH0KfQoKZnVuY3Rpb24gbWl4aW4oVnVlKSB7CiAgVnVlLm1peGluKHsKICAgIGJlZm9yZUNyZWF0ZTogZnVuY3Rpb25BcGlJbml0LAogICAgbW91bnRlZDogZnVuY3Rpb24gbW91bnRlZCgpIHsKICAgICAgdXBkYXRlVGVtcGxhdGVSZWYodGhpcyk7CiAgICB9LAogICAgdXBkYXRlZDogZnVuY3Rpb24gdXBkYXRlZCgpIHsKICAgICAgdXBkYXRlVGVtcGxhdGVSZWYodGhpcyk7CiAgICB9CiAgfSk7CiAgLyoqDQogICAqIFZ1ZXggaW5pdCBob29rLCBpbmplY3RlZCBpbnRvIGVhY2ggaW5zdGFuY2VzIGluaXQgaG9va3MgbGlzdC4NCiAgICovCgogIGZ1bmN0aW9uIGZ1bmN0aW9uQXBpSW5pdCgpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgJG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICAgIHZhciBzZXR1cCA9ICRvcHRpb25zLnNldHVwLAogICAgICAgIHJlbmRlciA9ICRvcHRpb25zLnJlbmRlcjsKCiAgICBpZiAocmVuZGVyKSB7CiAgICAgIC8vIGtlZXAgY3VycmVudEluc3RhbmNlIGFjY2Vzc2libGUgZm9yIGNyZWF0ZUVsZW1lbnQKICAgICAgJG9wdGlvbnMucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHZhciBhcmdzID0gW107CgogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYWN0aXZhdGVDdXJyZW50SW5zdGFuY2Uodm0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiByZW5kZXIuYXBwbHkoX3RoaXMsIGFyZ3MpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfQoKICAgIGlmICghc2V0dXApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0eXBlb2Ygc2V0dXAgIT09ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB3YXJuKCdUaGUgInNldHVwIiBvcHRpb24gc2hvdWxkIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgb2JqZWN0IGluIGNvbXBvbmVudCBkZWZpbml0aW9ucy4nLCB2bSk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgZGF0YSA9ICRvcHRpb25zLmRhdGE7IC8vIHdyYXBwZXIgdGhlIGRhdGEgb3B0aW9uLCBzbyB3ZSBjYW4gaW52b2tlIHNldHVwIGJlZm9yZSBkYXRhIGdldCByZXNvbHZlZAoKICAgICRvcHRpb25zLmRhdGEgPSBmdW5jdGlvbiB3cmFwcGVkRGF0YSgpIHsKICAgICAgaW5pdFNldHVwKHZtLCB2bS4kcHJvcHMpOwogICAgICByZXR1cm4gdHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicgPyBkYXRhLmNhbGwodm0sIHZtKSA6IGRhdGEgfHwge307CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaW5pdFNldHVwKHZtLCBwcm9wcykgewogICAgaWYgKHByb3BzID09PSB2b2lkIDApIHsKICAgICAgcHJvcHMgPSB7fTsKICAgIH0KCiAgICB2YXIgc2V0dXAgPSB2bS4kb3B0aW9ucy5zZXR1cDsKICAgIHZhciBjdHggPSBjcmVhdGVTZXR1cENvbnRleHQodm0pOyAvLyBmYWtlIHJlYWN0aXZlIGZvciBgdG9SZWZzKHByb3BzKWAKCiAgICBkZWYocHJvcHMsICdfX29iX18nLCBjcmVhdGVPYnNlcnZlcigpKTsgLy8gcmVzb2x2ZSBzY29wZWRTbG90cyBhbmQgc2xvdHMgdG8gZnVuY3Rpb25zCiAgICAvLyBAdHMtZXhwZWN0LWVycm9yCgogICAgcmVzb2x2ZVNjb3BlZFNsb3RzKHZtLCBjdHguc2xvdHMpOwogICAgdmFyIGJpbmRpbmc7CiAgICBhY3RpdmF0ZUN1cnJlbnRJbnN0YW5jZSh2bSwgZnVuY3Rpb24gKCkgewogICAgICAvLyBtYWtlIHByb3BzIHRvIGJlIGZha2UgcmVhY3RpdmUsIHRoaXMgaXMgZm9yIGB0b1JlZnMocHJvcHMpYAogICAgICBiaW5kaW5nID0gc2V0dXAocHJvcHMsIGN0eCk7CiAgICB9KTsKICAgIGlmICghYmluZGluZykgcmV0dXJuOwoKICAgIGlmIChpc0Z1bmN0aW9uKGJpbmRpbmcpKSB7CiAgICAgIC8vIGtlZXAgdHlwZXNjcmlwdCBoYXBweSB3aXRoIHRoZSBiaW5kaW5nIHR5cGUuCiAgICAgIHZhciBiaW5kaW5nRnVuY18xID0gYmluZGluZzsgLy8ga2VlcCBjdXJyZW50SW5zdGFuY2UgYWNjZXNzaWJsZSBmb3IgY3JlYXRlRWxlbWVudAoKICAgICAgdm0uJG9wdGlvbnMucmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IKICAgICAgICByZXNvbHZlU2NvcGVkU2xvdHModm0sIGN0eC5zbG90cyk7CiAgICAgICAgcmV0dXJuIGFjdGl2YXRlQ3VycmVudEluc3RhbmNlKHZtLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gYmluZGluZ0Z1bmNfMSgpOwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KGJpbmRpbmcpKSB7CiAgICAgIGlmIChpc1JlYWN0aXZlKGJpbmRpbmcpKSB7CiAgICAgICAgYmluZGluZyA9IHRvUmVmcyhiaW5kaW5nKTsKICAgICAgfQoKICAgICAgdm1TdGF0ZU1hbmFnZXIuc2V0KHZtLCAncmF3QmluZGluZ3MnLCBiaW5kaW5nKTsKICAgICAgdmFyIGJpbmRpbmdPYmpfMSA9IGJpbmRpbmc7CiAgICAgIE9iamVjdC5rZXlzKGJpbmRpbmdPYmpfMSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHZhciBiaW5kaW5nVmFsdWUgPSBiaW5kaW5nT2JqXzFbbmFtZV07CgogICAgICAgIGlmICghaXNSZWYoYmluZGluZ1ZhbHVlKSkgewogICAgICAgICAgaWYgKCFpc1JlYWN0aXZlKGJpbmRpbmdWYWx1ZSkpIHsKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oYmluZGluZ1ZhbHVlKSkgewogICAgICAgICAgICAgIGJpbmRpbmdWYWx1ZSA9IGJpbmRpbmdWYWx1ZS5iaW5kKHZtKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaXNPYmplY3QoYmluZGluZ1ZhbHVlKSkgewogICAgICAgICAgICAgIGJpbmRpbmdWYWx1ZSA9IHJlZihiaW5kaW5nVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc1JlYWN0aXZlQXJyYXlDaGlsZChiaW5kaW5nVmFsdWUpKSB7CiAgICAgICAgICAgICAgLy8gY3JlYXRlcyBhIGN1c3RvbSByZWFjdGl2ZSBwcm9wZXJ0aWVzIHdpdGhvdXQgbWFrZSB0aGUgb2JqZWN0IGV4cGxpY2l0bHkgcmVhY3RpdmUKICAgICAgICAgICAgICAvLyBOT1RFIHdlIHNob3VsZCB0cnkgdG8gYXZvaWQgdGhpcywgYmV0dGVyIGltcGxlbWVudGF0aW9uIG5lZWRlZAogICAgICAgICAgICAgIGN1c3RvbVJlYWN0aXZlKGJpbmRpbmdWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShiaW5kaW5nVmFsdWUpKSB7CiAgICAgICAgICAgIGJpbmRpbmdWYWx1ZSA9IHJlZihiaW5kaW5nVmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYXNWbVByb3BlcnR5KHZtLCBuYW1lLCBiaW5kaW5nVmFsdWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGFzc2VydChmYWxzZSwgIlwic2V0dXBcIiBtdXN0IHJldHVybiBhIFwiT2JqZWN0XCIgb3IgYSBcIkZ1bmN0aW9uXCIsIGdvdCBcIiIgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYmluZGluZykuc2xpY2UoOCwgLTEpICsgIlwiIik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjdXN0b21SZWFjdGl2ZSh0YXJnZXQpIHsKICAgIGlmICghaXNQbGFpbk9iamVjdCh0YXJnZXQpIHx8IGlzUmVmKHRhcmdldCkgfHwgaXNSZWFjdGl2ZSh0YXJnZXQpIHx8IGlzUmF3KHRhcmdldCkpIHJldHVybjsKICAgIHZhciBWdWUgPSBnZXRWdWVDb25zdHJ1Y3RvcigpOwogICAgdmFyIGRlZmluZVJlYWN0aXZlID0gVnVlLnV0aWwuZGVmaW5lUmVhY3RpdmU7CiAgICBPYmplY3Qua2V5cyh0YXJnZXQpLmZvckVhY2goZnVuY3Rpb24gKGspIHsKICAgICAgdmFyIHZhbCA9IHRhcmdldFtrXTsKICAgICAgZGVmaW5lUmVhY3RpdmUodGFyZ2V0LCBrLCB2YWwpOwoKICAgICAgaWYgKHZhbCkgewogICAgICAgIGN1c3RvbVJlYWN0aXZlKHZhbCk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gaGFzUmVhY3RpdmVBcnJheUNoaWxkKHRhcmdldCwgdmlzaXRlZCkgewogICAgaWYgKHZpc2l0ZWQgPT09IHZvaWQgMCkgewogICAgICB2aXNpdGVkID0gbmV3IE1hcCgpOwogICAgfQoKICAgIGlmICh2aXNpdGVkLmhhcyh0YXJnZXQpKSB7CiAgICAgIHJldHVybiB2aXNpdGVkLmdldCh0YXJnZXQpOwogICAgfQoKICAgIHZpc2l0ZWQuc2V0KHRhcmdldCwgZmFsc2UpOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNSZWFjdGl2ZSh0YXJnZXQpKSB7CiAgICAgIHZpc2l0ZWQuc2V0KHRhcmdldCwgdHJ1ZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGlmICghaXNQbGFpbk9iamVjdCh0YXJnZXQpIHx8IGlzUmF3KHRhcmdldCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiBPYmplY3Qua2V5cyh0YXJnZXQpLnNvbWUoZnVuY3Rpb24gKHgpIHsKICAgICAgcmV0dXJuIGhhc1JlYWN0aXZlQXJyYXlDaGlsZCh0YXJnZXRbeF0sIHZpc2l0ZWQpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTZXR1cENvbnRleHQodm0pIHsKICAgIHZhciBjdHggPSB7CiAgICAgIHNsb3RzOiB7fQogICAgfTsKICAgIHZhciBwcm9wc1BsYWluID0gWydyb290JywgJ3BhcmVudCcsICdyZWZzJywgJ2xpc3RlbmVycycsICdpc1NlcnZlcicsICdzc3JDb250ZXh0J107CiAgICB2YXIgcHJvcHNSZWFjdGl2ZVByb3h5ID0gWydhdHRycyddOwogICAgdmFyIG1ldGhvZFJldHVyblZvaWQgPSBbJ2VtaXQnXTsKICAgIHByb3BzUGxhaW4uZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBzcmNLZXkgPSAiJCIgKyBrZXk7CiAgICAgIHByb3h5KGN0eCwga2V5LCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gdm1bc3JjS2V5XTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KCkgewogICAgICAgICAgd2FybigiQ2Fubm90IGFzc2lnbiB0byAnIiArIGtleSArICInIGJlY2F1c2UgaXQgaXMgYSByZWFkLW9ubHkgcHJvcGVydHkiLCB2bSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogICAgcHJvcHNSZWFjdGl2ZVByb3h5LmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICB2YXIgc3JjS2V5ID0gIiQiICsga2V5OwogICAgICBwcm94eShjdHgsIGtleSwgewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgdmFyIGVfMSwgX2E7CgogICAgICAgICAgdmFyIGRhdGEgPSByZWFjdGl2ZSh7fSk7CiAgICAgICAgICB2YXIgc291cmNlID0gdm1bc3JjS2V5XTsKCiAgICAgICAgICB2YXIgX2xvb3BfMSA9IGZ1bmN0aW9uIF9sb29wXzEoYXR0cikgewogICAgICAgICAgICBwcm94eShkYXRhLCBhdHRyLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgICAvLyB0byBlbnN1cmUgaXQgYWx3YXlzIHJldHVybiB0aGUgbGF0ZXN0IHZhbHVlCiAgICAgICAgICAgICAgICByZXR1cm4gdm1bc3JjS2V5XVthdHRyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKCiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmb3IgKHZhciBfYiA9IF9fdmFsdWVzKE9iamVjdC5rZXlzKHNvdXJjZSkpLCBfYyA9IF9iLm5leHQoKTsgIV9jLmRvbmU7IF9jID0gX2IubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIGF0dHIgPSBfYy52YWx1ZTsKCiAgICAgICAgICAgICAgX2xvb3BfMShhdHRyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZV8xXzEpIHsKICAgICAgICAgICAgZV8xID0gewogICAgICAgICAgICAgIGVycm9yOiBlXzFfMQogICAgICAgICAgICB9OwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoX2MgJiYgIV9jLmRvbmUgJiYgKF9hID0gX2JbInJldHVybiJdKSkgX2EuY2FsbChfYik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKGVfMSkgdGhyb3cgZV8xLmVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCgpIHsKICAgICAgICAgIHdhcm4oIkNhbm5vdCBhc3NpZ24gdG8gJyIgKyBrZXkgKyAiJyBiZWNhdXNlIGl0IGlzIGEgcmVhZC1vbmx5IHByb3BlcnR5Iiwgdm0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICAgIG1ldGhvZFJldHVyblZvaWQuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBzcmNLZXkgPSAiJCIgKyBrZXk7CiAgICAgIHByb3h5KGN0eCwga2V5LCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBmbiA9IHZtW3NyY0tleV07CiAgICAgICAgICAgIGZuLmFwcGx5KHZtLCBhcmdzKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnKSB7CiAgICAgIGN0eC5fdm0gPSB2bTsKICAgIH0KCiAgICByZXR1cm4gY3R4OwogIH0KfQovKioNCiAqIEhlbHBlciB0aGF0IHJlY3Vyc2l2ZWx5IG1lcmdlcyB0d28gZGF0YSBvYmplY3RzIHRvZ2V0aGVyLg0KICovCgoKZnVuY3Rpb24gbWVyZ2VEYXRhKGZyb20sIHRvKSB7CiAgaWYgKCFmcm9tKSByZXR1cm4gdG87CiAgaWYgKCF0bykgcmV0dXJuIGZyb207CiAgdmFyIGtleTsKICB2YXIgdG9WYWw7CiAgdmFyIGZyb21WYWw7CiAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoZnJvbSkgOiBPYmplY3Qua2V5cyhmcm9tKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBrZXkgPSBrZXlzW2ldOyAvLyBpbiBjYXNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBvYnNlcnZlZC4uLgoKICAgIGlmIChrZXkgPT09ICdfX29iX18nKSBjb250aW51ZTsKICAgIHRvVmFsID0gdG9ba2V5XTsKICAgIGZyb21WYWwgPSBmcm9tW2tleV07CgogICAgaWYgKCFoYXNPd24odG8sIGtleSkpIHsKICAgICAgdG9ba2V5XSA9IGZyb21WYWw7CiAgICB9IGVsc2UgaWYgKHRvVmFsICE9PSBmcm9tVmFsICYmIGlzUGxhaW5PYmplY3QodG9WYWwpICYmICFpc1JlZih0b1ZhbCkgJiYgaXNQbGFpbk9iamVjdChmcm9tVmFsKSAmJiAhaXNSZWYoZnJvbVZhbCkpIHsKICAgICAgbWVyZ2VEYXRhKGZyb21WYWwsIHRvVmFsKTsKICAgIH0KICB9CgogIHJldHVybiB0bzsKfQoKZnVuY3Rpb24gX2luc3RhbGwoVnVlKSB7CiAgaWYgKGlzVnVlUmVnaXN0ZXJlZChWdWUpKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCdbdnVlLWNvbXBvc2l0aW9uLWFwaV0gYWxyZWFkeSBpbnN0YWxsZWQuIFZ1ZS51c2UoVnVlQ29tcG9zaXRpb25BUEkpIHNob3VsZCBiZSBjYWxsZWQgb25seSBvbmNlLicpOwogICAgfQoKICAgIHJldHVybjsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpZiAoVnVlLnZlcnNpb24pIHsKICAgICAgaWYgKFZ1ZS52ZXJzaW9uWzBdICE9PSAnMicgfHwgVnVlLnZlcnNpb25bMV0gIT09ICcuJykgewogICAgICAgIHdhcm4oIlt2dWUtY29tcG9zaXRpb24tYXBpXSBvbmx5IHdvcmtzIHdpdGggVnVlIDIsIHYiICsgVnVlLnZlcnNpb24gKyAiIGZvdW5kLiIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB3YXJuKCdbdnVlLWNvbXBvc2l0aW9uLWFwaV0gbm8gVnVlIHZlcnNpb24gZm91bmQnKTsKICAgIH0KICB9CgogIFZ1ZS5jb25maWcub3B0aW9uTWVyZ2VTdHJhdGVnaWVzLnNldHVwID0gZnVuY3Rpb24gKHBhcmVudCwgY2hpbGQpIHsKICAgIHJldHVybiBmdW5jdGlvbiBtZXJnZWRTZXR1cEZuKHByb3BzLCBjb250ZXh0KSB7CiAgICAgIHJldHVybiBtZXJnZURhdGEodHlwZW9mIHBhcmVudCA9PT0gJ2Z1bmN0aW9uJyA/IHBhcmVudChwcm9wcywgY29udGV4dCkgfHwge30gOiB1bmRlZmluZWQsIHR5cGVvZiBjaGlsZCA9PT0gJ2Z1bmN0aW9uJyA/IGNoaWxkKHByb3BzLCBjb250ZXh0KSB8fCB7fSA6IHVuZGVmaW5lZCk7CiAgICB9OwogIH07CgogIHNldFZ1ZUNvbnN0cnVjdG9yKFZ1ZSk7CiAgbWl4aW4oVnVlKTsKfQoKdmFyIFBsdWdpbiA9IHsKICBpbnN0YWxsOiBmdW5jdGlvbiBpbnN0YWxsKFZ1ZSkgewogICAgcmV0dXJuIF9pbnN0YWxsKFZ1ZSk7CiAgfQp9OyAvLyBpbXBsZW1lbnRhdGlvbiwgY2xvc2UgdG8gbm8tb3AKCmZ1bmN0aW9uIGRlZmluZUNvbXBvbmVudChvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnM7Cn0KCmZ1bmN0aW9uIGRlZmluZUFzeW5jQ29tcG9uZW50KHNvdXJjZSkgewogIGlmIChpc0Z1bmN0aW9uKHNvdXJjZSkpIHsKICAgIHNvdXJjZSA9IHsKICAgICAgbG9hZGVyOiBzb3VyY2UKICAgIH07CiAgfQoKICB2YXIgbG9hZGVyID0gc291cmNlLmxvYWRlciwKICAgICAgbG9hZGluZ0NvbXBvbmVudCA9IHNvdXJjZS5sb2FkaW5nQ29tcG9uZW50LAogICAgICBlcnJvckNvbXBvbmVudCA9IHNvdXJjZS5lcnJvckNvbXBvbmVudCwKICAgICAgX2EgPSBzb3VyY2UuZGVsYXksCiAgICAgIGRlbGF5ID0gX2EgPT09IHZvaWQgMCA/IDIwMCA6IF9hLAogICAgICB0aW1lb3V0ID0gc291cmNlLnRpbWVvdXQsCiAgICAgIC8vIHVuZGVmaW5lZCA9IG5ldmVyIHRpbWVzIG91dAogIF9iID0gc291cmNlLnN1c3BlbnNpYmxlLAogICAgICAvLyB1bmRlZmluZWQgPSBuZXZlciB0aW1lcyBvdXQKICBzdXNwZW5zaWJsZSA9IF9iID09PSB2b2lkIDAgPyBmYWxzZSA6IF9iLAogICAgICAvLyBpbiBWdWUgMyBkZWZhdWx0IGlzIHRydWUKICB1c2VyT25FcnJvciA9IHNvdXJjZS5vbkVycm9yOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBzdXNwZW5zaWJsZSkgewogICAgd2FybigiVGhlIHN1c3BlbnNpYmxiZSBvcHRpb24gZm9yIGFzeW5jIGNvbXBvbmVudHMgaXMgbm90IHN1cHBvcnRlZCBpbiBWdWUyLiBJdCBpcyBpZ25vcmVkLiIpOwogIH0KCiAgdmFyIHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICB2YXIgcmV0cmllcyA9IDA7CgogIHZhciByZXRyeSA9IGZ1bmN0aW9uIHJldHJ5KCkgewogICAgcmV0cmllcysrOwogICAgcGVuZGluZ1JlcXVlc3QgPSBudWxsOwogICAgcmV0dXJuIGxvYWQoKTsKICB9OwoKICB2YXIgbG9hZCA9IGZ1bmN0aW9uIGxvYWQoKSB7CiAgICB2YXIgdGhpc1JlcXVlc3Q7CiAgICByZXR1cm4gcGVuZGluZ1JlcXVlc3QgfHwgKHRoaXNSZXF1ZXN0ID0gcGVuZGluZ1JlcXVlc3QgPSBsb2FkZXIoKVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGVyciA9IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyIDogbmV3IEVycm9yKFN0cmluZyhlcnIpKTsKCiAgICAgIGlmICh1c2VyT25FcnJvcikgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB2YXIgdXNlclJldHJ5ID0gZnVuY3Rpb24gdXNlclJldHJ5KCkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXRyeSgpKTsKICAgICAgICAgIH07CgogICAgICAgICAgdmFyIHVzZXJGYWlsID0gZnVuY3Rpb24gdXNlckZhaWwoKSB7CiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTsKICAgICAgICAgIH07CgogICAgICAgICAgdXNlck9uRXJyb3IoZXJyLCB1c2VyUmV0cnksIHVzZXJGYWlsLCByZXRyaWVzICsgMSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICB9KS50aGVuKGZ1bmN0aW9uIChjb21wKSB7CiAgICAgIGlmICh0aGlzUmVxdWVzdCAhPT0gcGVuZGluZ1JlcXVlc3QgJiYgcGVuZGluZ1JlcXVlc3QpIHsKICAgICAgICByZXR1cm4gcGVuZGluZ1JlcXVlc3Q7CiAgICAgIH0KCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb21wKSB7CiAgICAgICAgd2FybigiQXN5bmMgY29tcG9uZW50IGxvYWRlciByZXNvbHZlZCB0byB1bmRlZmluZWQuICIgKyAiSWYgeW91IGFyZSB1c2luZyByZXRyeSgpLCBtYWtlIHN1cmUgdG8gcmV0dXJuIGl0cyByZXR1cm4gdmFsdWUuIik7CiAgICAgIH0gLy8gaW50ZXJvcCBtb2R1bGUgZGVmYXVsdAoKCiAgICAgIGlmIChjb21wICYmIChjb21wLl9fZXNNb2R1bGUgfHwgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykpIHsKICAgICAgICBjb21wID0gY29tcFsiZGVmYXVsdCJdOwogICAgICB9CgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb21wICYmICFpc09iamVjdChjb21wKSAmJiAhaXNGdW5jdGlvbihjb21wKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBhc3luYyBjb21wb25lbnQgbG9hZCByZXN1bHQ6ICIgKyBjb21wKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNvbXA7CiAgICB9KSk7CiAgfTsKCiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb21wb25lbnQgPSBsb2FkKCk7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgZGVsYXk6IGRlbGF5LAogICAgICB0aW1lb3V0OiB0aW1lb3V0LAogICAgICBlcnJvcjogZXJyb3JDb21wb25lbnQsCiAgICAgIGxvYWRpbmc6IGxvYWRpbmdDb21wb25lbnQKICAgIH07CiAgfTsKfQoKdmFyIHZlcnNpb24gPSAiMS4wLjAtcmMuMiI7IC8vIGF1dG8gaW5zdGFsbCB3aGVuIHVzaW5nIENETgoKaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5WdWUpIHsKICB3aW5kb3cuVnVlLnVzZShQbHVnaW4pOwp9CgpleHBvcnQgZGVmYXVsdCBQbHVnaW47CmV4cG9ydCB7IGNvbXB1dGVkLCBjcmVhdGVBcHAsIGN1c3RvbVJlZiwgZGVmaW5lQXN5bmNDb21wb25lbnQsIGRlZmluZUNvbXBvbmVudCwgZGVsLCBnZXRDdXJyZW50SW5zdGFuY2UsIGNyZWF0ZUVsZW1lbnQgYXMgaCwgaW5qZWN0LCBpc1JhdywgaXNSZWFjdGl2ZSwgaXNSZWFkb25seSwgaXNSZWYsIG1hcmtSYXcsIG5leHRUaWNrLCBvbkFjdGl2YXRlZCwgb25CZWZvcmVNb3VudCwgb25CZWZvcmVVbm1vdW50LCBvbkJlZm9yZVVwZGF0ZSwgb25EZWFjdGl2YXRlZCwgb25FcnJvckNhcHR1cmVkLCBvbk1vdW50ZWQsIG9uU2VydmVyUHJlZmV0Y2gsIG9uVW5tb3VudGVkLCBvblVwZGF0ZWQsIHByb3ZpZGUsIHByb3h5UmVmcywgcmVhY3RpdmUsIHJlYWRvbmx5LCByZWYsIHNldCwgc2hhbGxvd1JlYWN0aXZlLCBzaGFsbG93UmVhZG9ubHksIHNoYWxsb3dSZWYsIHRvUmF3LCB0b1JlZiwgdG9SZWZzLCB0cmlnZ2VyUmVmLCB1bnJlZiwgdXNlQ1NTTW9kdWxlLCB1c2VDc3NNb2R1bGUsIHZlcnNpb24sIHdhcm4kMSBhcyB3YXJuLCB3YXRjaCwgd2F0Y2hFZmZlY3QgfTs="},null]}